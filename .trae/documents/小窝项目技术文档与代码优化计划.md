# 小窝项目技术文档与代码优化计划

## 问题分析

根据技术方案文档和用户反馈，我识别出四个需要立即修复的关键问题：

### 1. CGO与SQLite兼容性陷阱
- **位置**：技术文档345-346行（数据库连接配置）
- **问题**：使用了依赖CGO的SQLite驱动`gorm.io/driver/sqlite`，但Dockerfile中设置了`CGO_ENABLED=0`
- **风险**：编译失败或运行时崩溃

### 2. 数据库路径与持久化错位
- **位置**：技术文档353行（DSN配置）
- **问题**：硬编码相对路径`file:xiaowo.db?`，未读取环境变量`DB_SOURCE`
- **风险**：数据未写入挂载卷，容器重建时数据丢失

### 3. Docker信号接收与数据刷盘
- **位置**：技术文档1800行（Dockerfile CMD指令）
- **问题**：使用相对路径`CMD ["./main"]`
- **风险**：信号传递可能失效，无法执行优雅退出和数据刷盘

### 4. GORM日志降噪
- **位置**：技术文档355-357行（GORM配置）
- **问题**：未配置日志级别，默认打印所有SQL语句
- **风险**：日志量过大，可能撑爆Docker日志驱动配额

## 修改方案

### 1. 更新数据库连接配置
- **文件**：技术文档340-366行
- **修改内容**：
  - 替换SQLite驱动为纯Go版本`github.com/glebarez/sqlite`
  - 添加环境变量读取逻辑，支持`DB_SOURCE`配置
  - 添加环境感知的日志配置

### 2. 更新Dockerfile CMD指令
- **文件**：技术文档1800行
- **修改内容**：将相对路径改为绝对路径`CMD ["/app/main"]`

### 3. 更新技术栈选型说明
- **文件**：技术文档36行
- **修改内容**：添加关于纯Go SQLite驱动的说明

## 具体修改内容

### 1. 数据库连接配置修改
```go
// database/database.go
package database

import (
    "os"
    "log"
    "time"
    "github.com/glebarez/sqlite" // 纯Go驱动，无需CGO
    "gorm.io/gorm"
    "gorm.io/gorm/logger"
)

// InitDB 初始化SQLite数据库连接
func InitDB() (*gorm.DB, error) {
    // 读取环境变量，支持外部配置数据库路径
    dbSource := os.Getenv("DB_SOURCE")
    if dbSource == "" {
        dbSource = "xiaowo.db" // 开发环境默认值
    }
    
    // SQLite DSN配置 - 强制开启WAL模式
    dsn := dbSource + "?cache=shared&mode=rwc&_journal_mode=WAL&_busy_timeout=5000"
    
    // 配置日志级别 - 生产环境仅打印错误
    logLevel := logger.Info
    if os.Getenv("GIN_MODE") == "release" {
        logLevel = logger.Error
    }
    
    newLogger := logger.New(
        log.New(os.Stdout, "\r\n", log.LstdFlags),
        logger.Config{
            SlowThreshold:             time.Second,
            LogLevel:                  logLevel,
            IgnoreRecordNotFoundError: true,
            Colorful:                  true,
        },
    )
    
    db, err := gorm.Open(sqlite.Open(dsn), &gorm.Config{
        Logger: newLogger,
    })
    if err != nil {
        return nil, err
    }
    
    // 自动迁移数据库表结构
    // db.AutoMigrate(&model.Room{}, &model.RoomMember{}, &model.UserSession{})
    
    return db, nil
}
```

### 2. Dockerfile CMD指令修改
```dockerfile
# 启动应用 - 使用绝对路径，确保信号正确传递
CMD ["/app/main"]
```

### 3. 技术栈选型说明修改
```markdown
- **SQLite**：单文件数据库，零配置，无需独立容器，完美契合单体架构与MVP需求。使用纯Go的SQLite驱动（github.com/glebarez/sqlite），避免CGO依赖，确保在Docker环境中稳定运行
```

## 预期效果

1. **编译与运行稳定**：使用纯Go驱动消除CGO依赖，确保在`CGO_ENABLED=0`环境下正常编译和运行
2. **数据持久化可靠**：读取环境变量配置数据库路径，确保数据写入挂载卷，容器重建时数据不丢失
3. **信号传递正常**：使用绝对路径的CMD指令，确保SIGTERM信号能被正确捕获，执行优雅退出和数据刷盘
4. **日志量可控**：生产环境仅打印错误日志，避免日志爆炸
5. **文档与代码一致**：技术文档准确反映实际代码实现，便于后续维护和团队协作

## 实施步骤

1. 更新技术方案文档中的数据库连接配置代码块
2. 更新技术方案文档中的Dockerfile CMD指令
3. 更新技术方案文档中的技术栈选型说明
4. 根据文档更新实际代码文件（database.go和Dockerfile）
5. 验证修改后的代码能正常编译和运行

以上修改计划已准备就绪，可根据用户反馈调整后实施。