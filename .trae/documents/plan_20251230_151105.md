# B-003 房间管理核心API开发计划

## 1. 任务目标
开发完整的多人观影房间管理系统，包括房间创建、加入、退出、状态同步等核心API接口，为前端房间页面提供完整的后端支持。

## 2. 技术现状分析

### 已实现功能
- 房间模型定义（Room, RoomMember）
- 房间服务层基础实现
- 房间API基础实现：
  - 创建房间 (POST /api/rooms)
  - 获取房间信息 (GET /api/rooms/:roomId)
  - 加入房间 (POST /api/rooms/join) - 路由格式不符合要求
  - 退出房间 (POST /api/rooms/:roomId/leave)
  - 更新房间信息 (PUT /api/rooms/:roomId)
  - 获取房间列表 (GET /api/rooms)

### 待实现功能
- 关闭房间 (DELETE /api/rooms/:roomId)
- 获取房间成员列表 (GET /api/rooms/:roomId/members)
- 视频播放控制 (POST /api/rooms/:roomId/play)
- 视频暂停控制 (POST /api/rooms/:roomId/pause)
- 视频跳转控制 (POST /api/rooms/:roomId/seek)
- 播放状态同步 (GET /api/rooms/:roomId/status)
- 修正加入房间路由格式
- WebSocket支持房间状态实时同步

## 3. 开发计划

### 3.1 修正路由格式
- 修改 `RoomHandler.JoinRoom` 函数的路由，从 `POST /api/rooms/join` 改为 `POST /api/rooms/:roomId/join`
- 更新请求处理逻辑，从URL参数获取roomId

### 3.2 实现关闭房间功能
- 在 `RoomHandler` 中添加 `CloseRoom` 函数
- 实现 `RoomService.CloseRoom` 方法
- 添加权限验证，只有房间创建者可以关闭房间
- 更新房间状态为关闭

### 3.3 实现房间成员管理功能
- 在 `RoomHandler` 中添加 `GetRoomMembers` 函数
- 实现 `MemberService.GetRoomMembers` 方法
- 返回房间成员列表，包含成员角色和状态

### 3.4 实现视频同步控制功能
- 在 `RoomHandler` 中添加视频控制相关函数：
  - `PlayVideo` - 处理视频播放请求
  - `PauseVideo` - 处理视频暂停请求
  - `SeekVideo` - 处理视频跳转请求
  - `GetPlaybackStatus` - 获取当前播放状态
- 在 `RoomService` 中实现对应的方法
- 确保播放状态更新时版本号递增

### 3.5 实现WebSocket支持
- 完善 `websocket` 包的实现
- 添加WebSocket连接管理
- 实现房间状态实时同步
- 实现播放状态变化广播
- 实现成员加入/退出通知

### 3.6 测试验证
- 运行API测试
- 验证所有API功能正常工作
- 测试WebSocket连接和状态同步
- 测试房间成员管理功能
- 测试视频同步控制功能

## 4. 代码结构

### 核心文件
- `/backend/internal/api/v1/room.go` - 房间API控制器
- `/backend/internal/service/room_service.go` - 房间业务逻辑
- `/backend/internal/repository/room_repo.go` - 房间数据访问
- `/backend/internal/model/room.go` - 房间模型定义
- `/backend/internal/websocket/hub.go` - WebSocket连接管理

## 5. 接口设计

### 5.1 房间生命周期管理
- `POST /api/rooms` - 创建房间
- `GET /api/rooms/:roomId` - 获取房间信息
- `POST /api/rooms/:roomId/join` - 加入房间
- `POST /api/rooms/:roomId/leave` - 退出房间
- `DELETE /api/rooms/:roomId` - 关闭房间

### 5.2 房间成员管理
- `GET /api/rooms/:roomId/members` - 获取房间成员列表

### 5.3 视频同步控制
- `POST /api/rooms/:roomId/play` - 视频播放控制
- `POST /api/rooms/:roomId/pause` - 视频暂停控制
- `POST /api/rooms/:roomId/seek` - 视频跳转控制
- `GET /api/rooms/:roomId/status` - 播放状态同步

### 5.4 WebSocket接口
- `GET /ws/room/:roomId` - WebSocket连接，用于实时同步房间状态

## 6. 实现顺序

1. 修正加入房间路由格式
2. 实现关闭房间功能
3. 实现获取房间成员列表功能
4. 实现视频同步控制功能
5. 实现WebSocket支持
6. 测试验证

## 7. 验收标准

1. 功能完整性：所有房间管理API都能正常工作
2. 数据一致性：房间状态和成员信息准确同步
3. 实时性：WebSocket连接稳定，状态同步及时
4. 错误处理：各种异常情况都有合适的处理
5. 性能表现：支持多用户并发，响应时间合理
6. API文档完整：提供详细的API文档