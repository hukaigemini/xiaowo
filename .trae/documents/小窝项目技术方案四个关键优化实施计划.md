# 小窝项目技术方案优化实施计划

根据用户提出的四个关键优化建议，我将对技术方案文档进行以下补充：

## 一、播放器状态同步恢复策略优化

### 修改位置
在 **3.3 WebSocket消息协议** 的"操作界限明确化"小节后新增 **"网络重连与状态恢复策略"** 小节

### 新增内容
1. **重连后自动状态拉取机制**
   - WebSocket重连成功后立即发送 `MSG_SYNC` 请求
   - 服务器响应包含完整房间状态（播放/暂停、当前进度、播放倍速）
2. **平滑过渡策略**
   - 差异<2秒：使用"微温柔调"策略追帧（0.05s-3s的Sync Tolerance）
   - 差异>2秒：执行Seek操作，避免画面突变
3. **技术实现示例**
   ```javascript
   // WebSocket重连成功后的状态恢复
   function handleReconnectSuccess() {
     // 1. 发送同步请求
     socket.send(JSON.stringify({
       type: MSG_SYNC,
       room_id: currentRoomId
     }));
     
     // 2. 收到服务器响应后对比本地状态
     // 3. 根据差异大小选择追帧策略
   }
   ```

## 二、视频源解析预检机制优化

### 修改位置
在 **4.1.4 资源兼容性与稳定性** 的"防盗链适配"后新增 **"前端视频源预检机制"** 小节

### 新增内容
1. **预检流程设计**
   - 用户输入链接并点击"加载"时，前端使用隐藏`<video>`标签进行预加载
   - 监听`canplay`事件：成功则发送UpdateRoom请求
   - 监听`error`事件：失败则提示用户链接无效
2. **防止房间污染**
   - 无效链接不会广播给其他房间成员
   - 提供友好的错误提示和引导
3. **技术实现示例**
   ```javascript
   function precheckVideoSource(url) {
     const testVideo = document.createElement('video');
     testVideo.style.display = 'none';
     
     testVideo.addEventListener('canplay', () => {
       // 验证成功，更新房间视频链接
       updateRoomVideo(url);
     });
     
     testVideo.addEventListener('error', (e) => {
       // 验证失败，提示用户
       showError('视频链接无效或存在跨域限制，请检查后重试');
     });
     
     testVideo.src = url;
   }
   ```

## 三、SQLite写入频率防抖优化

### 修改位置
在 **2.3 数据访问层设计** 的Repository模式实现后新增 **"数据写入优化策略"** 小节

### 新增内容
1. **内存缓冲机制**
   - `current_time`、`playback_state`等高频数据主要维护在Go内存结构体中
   - 使用`sync.RWMutex`保证并发安全
2. **异步落盘策略**
   - **定时同步**：每10-30秒将内存状态批量写入SQLite
   - **事件触发**：暂停、Seek、用户离开、房间销毁等关键事件发生时立即写入
3. **性能收益**
   - 大幅降低磁盘IOPS（从每秒多次降到每10-30秒一次）
   - 减少SQLite锁竞争，提升并发性能
4. **技术实现示例**
   ```go
   type RoomStateCache struct {
     mu            sync.RWMutex
     lastWriteTime time.Time
     dirty         bool
     currentTime   float64
     playbackState string
   }
   ```

## 四、调试工具后门优化

### 修改位置
在 **4.1.5 前端播放器逻辑优化** 的"播放器核心逻辑"后新增 **"开发调试工具"** 小节

### 新增内容
1. **调试面板激活方式**
   - 连续点击标题5次唤出浮层面板
   - 支持快捷键（如Ctrl+Shift+D）切换显示
2. **实时监控信息展示**
   - RTT数值及变化趋势图
   - 当前计算出的TimeDiff（时间差）
   - WebSocket连接状态（连接中/已连接/断开）
   - 最后一条收到的指令内容及时间戳
3. **故障排查辅助**
   - 一键导出当前状态快照
   - 手动发送测试指令功能
   - 网络模拟工具（延迟/丢包）
4. **技术实现示例**
   ```javascript
   // 连续点击检测
   let clickCount = 0;
   let lastClickTime = 0;
   
   document.getElementById('title').addEventListener('click', () => {
     const now = Date.now();
     if (now - lastClickTime > 1000) {
       clickCount = 0; // 重置计数
     }
     clickCount++;
     lastClickTime = now;
     
     if (clickCount >= 5) {
       toggleDebugPanel();
       clickCount = 0;
     }
   });
   ```

## 实施顺序与工作量评估
1. **播放器状态同步恢复策略**（约30分钟）- 优先级：高
2. **SQLite写入频率防抖**（约45分钟）- 优先级：高
3. **视频源解析预检机制**（约40分钟）- 优先级：中
4. **调试工具后门**（约60分钟）- 优先级：中

所有修改将在技术方案文档的现有框架内完成，保持章节编号连贯性和文档结构清晰度。