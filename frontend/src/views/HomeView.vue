<template>
  <div class="min-h-screen flex flex-col items-center justify-center bg-bg text-text-main font-sans overflow-hidden selection:bg-primary selection:text-white relative">
    
    <!-- è£…é¥°èƒŒæ™¯ï¼šæŸ”å’Œçš„æ¼«åå°„å…‰æ™• -->
    <div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
      <div class="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-primary/10 rounded-full blur-[100px]"></div>
      <div class="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-secondary/10 rounded-full blur-[80px]"></div>
    </div>

    <!-- é¦–é¡µï¼šæ¬¢è¿å¡ç‰‡ -->
    <div class="relative z-10 w-full max-w-md px-6 animate-fade-in">
      
      <!-- ä¸»å¡ç‰‡ -->
      <div class="bg-surface rounded-4xl p-8 shadow-card border-2 border-white/50 relative overflow-hidden mt-8">
        
        <!-- é¡¶éƒ¨è£…é¥°çº¿ -->
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary/20 via-primary/40 to-primary/20"></div>

        <!-- æ ‡é¢˜åŒº -->
        <div class="text-center mb-10 mt-2">
          <div class="inline-flex items-center justify-center w-20 h-20 bg-white rounded-full shadow-lg mb-6 transform hover:scale-105 hover:shadow-xl transition-all duration-300 cursor-default">
            <svg class="w-10 h-10 text-primary" viewBox="0 0 24 24" fill="currentColor">
              <!-- å°çªlogoï¼šèˆ’é€‚çš„æ²™å‘ -->
              <!-- æ²™å‘ä¸»ä½“ -->
              <path d="M3 14c0-3.5 2.5-6 7-6h4c4.5 0 7 2.5 7 6v2H3v-2z"/>
              <!-- æ²™å‘é èƒŒ -->
              <rect x="2" y="6" width="20" height="10" rx="2" fill="currentColor"/>
              <!-- æ²™å‘æ‰¶æ‰‹ -->
              <rect x="1" y="10" width="4" height="6" rx="1" fill="currentColor"/>
              <rect x="19" y="10" width="4" height="6" rx="1" fill="currentColor"/>
              <!-- æ²™å‘è…¿ -->
              <rect x="4" y="16" width="2" height="3" rx="1" fill="currentColor" opacity="0.7"/>
              <rect x="18" y="16" width="2" height="3" rx="1" fill="currentColor" opacity="0.7"/>
              <!-- æ¸©é¦¨è£…é¥°ï¼šåå«è¤¶çš± -->
              <path d="M8 10h8M8 12h6" stroke="currentColor" stroke-width="1" opacity="0.6"/>
            </svg>
          </div>
          <h1 class="text-3xl font-bold tracking-tight text-text-main mb-2">å°çª</h1>
          <p class="text-text-muted font-medium px-4">"å†è¿œï¼Œä¹Ÿè¦çªåœ¨ä¸€èµ·"</p>
        </div>

        <!-- MVPé˜¶æ®µç§»é™¤å¿«é€Ÿå›æˆ¿æç¤º -->

        <!-- æ ¸å¿ƒæ“ä½œåŒº -->
        <div class="space-y-6">
          
          <!-- åˆ›å»ºæˆ¿é—´ -->
          <button 
            @click="createRoom"
            class="w-full py-4 bg-[#FF9F76] hover:bg-[#FF8C5A] text-white font-bold text-lg rounded-2xl shadow-[0_8px_20px_-6px_rgba(255,159,118,0.5)] hover:shadow-[0_12px_25px_-8px_rgba(255,159,118,0.6)] hover:-translate-y-1 transition-all duration-300 active:scale-95 flex items-center justify-center space-x-2 group cursor-pointer"
          >
            <span>âœ¨ æ­ä¸ªæ¸©é¦¨å°çª</span>
            <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
          </button>

          <!-- åˆ†éš”ç¬¦ -->
          <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t-2 border-[#E6D5B8]"></div>
            <span class="flex-shrink-0 mx-4 text-text-muted text-sm font-medium">æˆ–</span>
            <div class="flex-grow border-t-2 border-[#E6D5B8]"></div>
          </div>

          <!-- åŠ å…¥æˆ¿é—´ -->
          <div class="space-y-3">
            <div class="relative group mt-1 mb-1">
              <input 
                v-model="roomId"
                type="text" 
                placeholder="è¾“å…¥æš—å· (æˆ¿é—´å·)..." 
                class="w-full px-6 py-3 bg-bg rounded-2xl border-2 border-transparent focus:border-primary focus:outline-none text-lg text-text-main placeholder-[#C5B4A0] transition-all shadow-inner-warm text-center font-medium tracking-widest"
                @keyup.enter="joinRoom"
              >
            </div>
            <button 
              @click="joinRoom"
              :disabled="!roomId.trim()"
              class="w-full py-3 bg-white border-2 border-[#E6D5B8] text-text-muted font-bold rounded-2xl hover:bg-[#FFFBF0] hover:text-text-main hover:border-primary/30 transition-all duration-300 active:scale-95 shadow-sm disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
            >
              æ•²é—¨è¿›å…¥
            </button>
          </div>
        </div>
      </div>

      <!-- åº•éƒ¨ä¿¡æ¯ -->
      <div class="mt-8 text-center">
        <p class="text-text-muted/60 text-xs font-medium tracking-wider mb-4">ğŸ”’ åªæœ‰ä½ ä»¬çŸ¥é“è¿™é‡Œã€‚å°±åƒåœ¨å®¶é‡Œå…³ä¸Šé—¨ä¸€æ ·å®‰å…¨ã€‚</p>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useRoomStore } from '@/store/modules/room'
import { useUserStore } from '@/store/modules/user'

const router = useRouter()
const roomStore = useRoomStore()
const userStore = useUserStore()

// å“åº”å¼æ•°æ®
const roomId = ref('')

// åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€
onMounted(async () => {
  await userStore.initialize()
})

// è¿›å…¥æˆ¿é—´
const enterRoom = async (targetRoomId?: string) => {
  try {
    // ä¿å­˜æˆ¿é—´ä¿¡æ¯åˆ°LocalStorage
    const finalRoomId = targetRoomId || roomId.value || generateRoomId()
    localStorage.setItem('xiaowo_room', JSON.stringify({
      roomId: finalRoomId,
      lastVisit: Date.now()
    }))
    
    // è·¯ç”±è·³è½¬
    await router.push(`/room/${finalRoomId}`)
  } catch (error) {
    console.error('è¿›å…¥æˆ¿é—´å¤±è´¥:', error)
  }
}

// åˆ›å»ºæˆ¿é—´
const createRoom = async () => {
  try {
    await userStore.initialize()
    if (!userStore.currentUser) {
      // å¦‚æœæ²¡æœ‰ç”¨æˆ·ï¼Œå…ˆåˆ›å»ºç”¨æˆ·
      await userStore.createTempUser('è§‚ä¼—' + Math.floor(Math.random() * 1000))
    }
    
    const newRoom = await roomStore.createRoom()
    await enterRoom(newRoom.id)
  } catch (error) {
    console.error('åˆ›å»ºæˆ¿é—´å¤±è´¥:', error)
  }
}

// åŠ å…¥æˆ¿é—´
const joinRoom = async () => {
  if (!roomId.value.trim()) return
  
  try {
    await userStore.initialize()
    if (!userStore.currentUser) {
      await userStore.createTempUser('è§‚ä¼—' + Math.floor(Math.random() * 1000))
    }
    
    await roomStore.joinRoom(roomId.value.trim())
    await enterRoom(roomId.value.trim())
  } catch (error) {
    console.error('åŠ å…¥æˆ¿é—´å¤±è´¥:', error)
  }
}

// ç”Ÿæˆéšæœºæˆ¿é—´å·
const generateRoomId = (): string => {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
  let result = ''
  for (let i = 0; i < 6; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length))
  }
  return result
}
</script>

<style scoped>
/* è‡ªå®šä¹‰åŠ¨ç”» */
@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

@keyframes slideUp {
  from {
    transform: translateY(10px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes pulseWarm {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.animate-fade-in {
  animation: fadeIn 0.5s ease-in-out;
}

.animate-slide-up {
  animation: slideUp 0.3s ease-out;
}

.animate-pulse-warm {
  animation: pulseWarm 2s infinite;
}
</style>