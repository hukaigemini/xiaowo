groups:
  - name: xiaowo-infrastructure
    rules:
      # 后端服务可用性告警
      - alert: BackendServiceDown
        expr: up{job="xiaowo-backend"} == 0
        for: 1m
        labels:
          severity: critical
          service: backend
        annotations:
          summary: "小窝后端服务不可用"
          description: "后端服务 {{ $labels.instance }} 已经宕机超过 1 分钟"
          runbook_url: "https://docs.xiaowo.com/runbooks/backend-down"

      # 前端服务可用性告警
      - alert: FrontendServiceDown
        expr: up{job="xiaowo-frontend"} == 0
        for: 1m
        labels:
          severity: critical
          service: frontend
        annotations:
          summary: "小窝前端服务不可用"
          description: "前端服务 {{ $labels.instance }} 已经宕机超过 1 分钟"

      # Redis 服务告警
      - alert: RedisDown
        expr: up{job="xiaowo-redis"} == 0
        for: 30s
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis 服务不可用"
          description: "Redis 服务 {{ $labels.instance }} 已经宕机超过 30 秒"

  - name: xiaowo-performance
    rules:
      # HTTP 错误率告警
      - alert: HighHTTPErrorRate
        expr: |
          (
            rate(http_requests_total{job="xiaowo-backend",status=~"5.."}[5m]) 
            / 
            rate(http_requests_total{job="xiaowo-backend"}[5m])
          ) * 100 > 5
        for: 2m
        labels:
          severity: warning
          service: backend
        annotations:
          summary: "后端 HTTP 错误率过高"
          description: "后端服务 HTTP 错误率超过 5%，当前值: {{ $value }}%"

      # HTTP 响应时间告警
      - alert: HighHTTPResponseTime
        expr: |
          histogram_quantile(0.95, 
            rate(http_request_duration_seconds_bucket{job="xiaowo-backend"}[5m])
          ) > 2
        for: 5m
        labels:
          severity: warning
          service: backend
        annotations:
          summary: "后端 HTTP 响应时间过长"
          description: "95% 的 HTTP 请求响应时间超过 2s，当前值: {{ $value }}s"

      # WebSocket 连接数异常
      - alert: WebSocketConnectionsHigh
        expr: websocket_connections_active > 100
        for: 5m
        labels:
          severity: warning
          service: backend
        annotations:
          summary: "WebSocket 连接数过高"
          description: "活跃 WebSocket 连接数超过 100，当前值: {{ $value }}"

  - name: xiaowo-infrastructure-resources
    rules:
      # CPU 使用率告警
      - alert: HighCPUUsage
        expr: |
          100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          component: node
        annotations:
          summary: "服务器 CPU 使用率过高"
          description: "服务器 {{ $labels.instance }} CPU 使用率超过 80%，当前值: {{ $value }}%"

      # 内存使用率告警
      - alert: HighMemoryUsage
        expr: |
          (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
          component: node
        annotations:
          summary: "服务器内存使用率过高"
          description: "服务器 {{ $labels.instance }} 内存使用率超过 85%，当前值: {{ $value }}%"

      # 磁盘空间告警
      - alert: HighDiskUsage
        expr: |
          (node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_free_bytes{fstype!="tmpfs"}) 
          / node_filesystem_size_bytes{fstype!="tmpfs"} * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: node
        annotations:
          summary: "磁盘空间不足"
          description: "服务器 {{ $labels.instance }} 磁盘使用率超过 80%，当前值: {{ $value }}%"

  - name: xiaowo-business-metrics
    rules:
      # 活跃房间数异常
      - alert: ActiveRoomsDrop
        expr: active_rooms_count < 5
        for: 10m
        labels:
          severity: info
          service: backend
        annotations:
          summary: "活跃房间数异常下降"
          description: "活跃房间数低于 5，当前值: {{ $value }}"

      # 同时在线用户数异常
      - alert: OnlineUsersDrop
        expr: online_users_count < 10
        for: 10m
        labels:
          severity: info
          service: backend
        annotations:
          summary: "同时在线用户数异常下降"
          description: "同时在线用户数低于 10，当前值: {{ $value }}"
