name: å°æ²ƒé¡¹ç›®CI/CDæµæ°´çº¿
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  GO_VERSION: '1.21'
  NODE_VERSION: '18'

jobs:
  # åŸºç¡€ç¯å¢ƒæ£€æŸ¥
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    # åç«¯ä»£ç è´¨é‡æ£€æŸ¥
    - name: åç«¯ä»£ç æ£€æŸ¥
      run: |
        cd backend
        # æ£€æŸ¥å¯¼å…¥
        go mod download
        go mod tidy
        
    # åç«¯é™æ€ä»£ç åˆ†æ
    - name: åç«¯é™æ€ä»£ç åˆ†æ (SonarQube)
      uses: sonarqube-quality-gate-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        scanMetadataReportFile: .scannerwork/report-task.txt

    # åç«¯å®‰å…¨æ‰«æ
    - name: åç«¯å®‰å…¨æ‰«æ (Gosec)
      run: |
        cd backend
        # å®‰è£…gosec
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
        # è¿è¡Œå®‰å…¨æ‰«æ
        gosec -fmt sarif -out results.sarif ./...
        # æ˜¾ç¤ºæ‰«æç»“æœ
        gosec ./...

    # åç«¯ä»£ç è§„èŒƒæ£€æŸ¥
    - name: åç«¯ä»£ç è§„èŒƒæ£€æŸ¥ (Golint)
      run: |
        cd backend
        # å®‰è£…golangci-lint
        curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.54.2
        # è¿è¡Œä»£ç è§„èŒƒæ£€æŸ¥
        golangci-lint run
        # è¿è¡ŒGo fmtæ£€æŸ¥
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "Goä»£ç æ ¼å¼ä¸è§„èŒƒ:"
          gofmt -s -l .
          exit 1
        fi
        # è¿è¡Œé™æ€æ£€æŸ¥
        go vet ./...

    # åç«¯å•å…ƒæµ‹è¯•
    - name: åç«¯å•å…ƒæµ‹è¯•
      run: |
        cd backend
        # å®‰è£…æµ‹è¯•ä¾èµ–
        go install github.com/onsi/ginkgo/v2/ginkgo@latest
        go install github.com/onsi/gomega@latest
        
        # è¿è¡Œå•å…ƒæµ‹è¯•
        go test -v -race -coverprofile=coverage.out ./...
        go tool cover -html=coverage.out -o coverage.html
        
        # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        go test -json ./... > test-results.json
        
    # åç«¯é›†æˆæµ‹è¯•
    - name: åç«¯é›†æˆæµ‹è¯•
      run: |
        cd backend
        # å¯åŠ¨æµ‹è¯•æ•°æ®åº“
        docker-compose up -d test-db
        sleep 15
        # ç­‰å¾…æ•°æ®åº“å°±ç»ª
        until docker-compose exec -T test-db pg_isready -U postgres; do
          echo "ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
          sleep 2
        done
        
        # è¿è¡Œé›†æˆæµ‹è¯•
        go test -tags=integration -v ./internal/test/...
        
        # è¿è¡ŒRepositoryå±‚æµ‹è¯•
        go run internal/repository/test_session_integration.go

    # å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥
    - name: å‰ç«¯ä»£ç è´¨é‡æ£€æŸ¥ (ESLint)
      run: |
        cd frontend
        npm ci
        # è¿è¡ŒESLintæ£€æŸ¥
        npm run lint
        # è¿è¡Œç±»å‹æ£€æŸ¥
        npm run type-check

    # å‰ç«¯å®‰å…¨æ‰«æ
    - name: å‰ç«¯å®‰å…¨æ‰«æ (npm audit)
      run: |
        cd frontend
        # è¿è¡Œnpmå®‰å…¨å®¡è®¡
        npm audit --audit-level=moderate
        # æ£€æŸ¥ä¾èµ–æ¼æ´
        npm run security:check || true

    # å‰ç«¯å•å…ƒæµ‹è¯•
    - name: å‰ç«¯å•å…ƒæµ‹è¯•
      run: |
        cd frontend
        # å®‰è£…æµ‹è¯•ä¾èµ–
        npm ci
        # è¿è¡Œå•å…ƒæµ‹è¯•
        npm test -- --run --coverage --reporter=verbose
        # ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        npm run test:coverage

    # å‰ç«¯E2Eæµ‹è¯•
    - name: å‰ç«¯E2Eæµ‹è¯• (Playwright)
      run: |
        cd frontend
        # å®‰è£…Playwright
        npm install --save-dev @playwright/test
        npx playwright install --with-deps
        # è¿è¡ŒE2Eæµ‹è¯•
        npx playwright test
        
    # å‰ç«¯ç»„ä»¶æµ‹è¯•
    - name: å‰ç«¯ç»„ä»¶æµ‹è¯•
      run: |
        cd frontend
        # è¿è¡Œç»„ä»¶æµ‹è¯•
        npm test src/components/__tests__/ --run --coverage
        npm test src/views/__tests__/ --run --coverage

    # å‰ç«¯æ„å»ºå’Œæµ‹è¯•
    - name: å‰ç«¯æ„å»ºæµ‹è¯•
      run: |
        cd frontend
        # è¿è¡Œç±»å‹æ£€æŸ¥
        npm run type-check
        # æ„å»ºé¡¹ç›®
        npm run build
        # éªŒè¯æ„å»ºç»“æœ
        if [ ! -d "dist" ]; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼šdistç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "âœ… å‰ç«¯æ„å»ºæˆåŠŸ"

    # ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: |
          backend/coverage.html
          frontend/coverage
        retention-days: 30

  # APIæ¥å£è‡ªåŠ¨åŒ–æµ‹è¯•
  api-testing:
    runs-on: ubuntu-latest
    needs: lint-and-test
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: tests/package-lock.json

    - name: å¯åŠ¨æœåŠ¡ç¯å¢ƒ
      run: |
        # å¯åŠ¨æµ‹è¯•æ•°æ®åº“
        cd tests
        docker-compose -f docker-compose.test.yml up -d
        
        # ç­‰å¾…æµ‹è¯•æ•°æ®åº“å¯åŠ¨
        sleep 15
        until docker exec xiaowo-test-db pg_isready -U test_user -d xiaowo_test; do
          echo "ç­‰å¾…æµ‹è¯•æ•°æ®åº“å¯åŠ¨..."
          sleep 2
        done
        until docker exec xiaowo-test-redis redis-cli ping | grep -q PONG; do
          echo "ç­‰å¾…Rediså¯åŠ¨..."
          sleep 2
        done
        
        # å¯åŠ¨åç«¯æœåŠ¡
        cd ../backend
        docker-compose up -d
        
        # å¯åŠ¨å‰ç«¯æœåŠ¡
        cd ../frontend
        docker-compose up -d || true
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 30
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        curl -f http://localhost:8080/health || exit 1

    - name: å®‰è£…APIæµ‹è¯•ä¾èµ–
      run: |
        cd tests
        npm ci

    - name: è¿è¡ŒAPIå†’çƒŸæµ‹è¯•
      run: |
        cd tests
        ./run_tests.sh --mode quick --report

    - name: è¿è¡Œå®Œæ•´APIæµ‹è¯•
      run: |
        cd tests
        ./run_tests.sh --mode full --env development --report --coverage

    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      run: |
        cd tests
        # å¤åˆ¶æŠ¥å‘Šåˆ°ç»Ÿä¸€ä½ç½®
        mkdir -p test-reports
        cp reports/*.html test-reports/ 2>/dev/null || true
        cp coverage/* test-reports/ 2>/dev/null || true

    - name: ä¸Šä¼ APIæµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: api-test-reports
        path: tests/test-reports/
        retention-days: 90

    - name: æ¸…ç†æµ‹è¯•ç¯å¢ƒ
      if: always()
      run: |
        docker-compose -f backend/docker-compose.yml down || true
        docker-compose -f frontend/docker-compose.yml down || true

  # ä¾èµ–å®‰å…¨æ‰«æ
  dependency-scan:
    runs-on: ubuntu-latest
    needs: lint-and-test
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    # åç«¯ä¾èµ–å®‰å…¨æ‰«æ
    - name: åç«¯ä¾èµ–å®‰å…¨æ‰«æ (Gosec)
      run: |
        cd backend
        # å®‰è£…gosec
        go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
        # è¿è¡Œå®‰å…¨æ‰«æ
        gosec -fmt sarif -out results.sarif ./...
        # æ˜¾ç¤ºæ‰«æç»“æœ
        gosec ./...

    - name: ä¸Šä¼ åç«¯å®‰å…¨æ‰«æç»“æœ
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: backend/results.sarif

    # å‰ç«¯ä¾èµ–å®‰å…¨æ‰«æ
    - name: å‰ç«¯ä¾èµ–å®‰å…¨æ‰«æ (npm audit)
      run: |
        cd frontend
        # è¿è¡Œnpmå®‰å…¨å®¡è®¡
        npm audit --audit-level=moderate --json > audit-results.json || true
        # æ£€æŸ¥ä¾èµ–æ¼æ´
        npm run security:check || true

    # ç¬¬ä¸‰æ–¹åº“æ¼æ´æ‰«æ
    - name: ç¬¬ä¸‰æ–¹åº“æ¼æ´æ‰«æ (Snyk)
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

  # ä»£ç è´¨é‡é—¨ç¦
  quality-gate:
    runs-on: ubuntu-latest
    needs: [lint-and-test, dependency-scan]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    # è´¨é‡é—¨ç¦æ£€æŸ¥
    - name: è´¨é‡é—¨ç¦æ£€æŸ¥
      run: |
        echo "ğŸ” æ‰§è¡Œè´¨é‡é—¨ç¦æ£€æŸ¥..."
        
        # æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
        cd backend
        if [ -f coverage.out ]; then
          COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}')
          echo "åç«¯æµ‹è¯•è¦†ç›–ç‡: $COVERAGE"
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ æµ‹è¯•è¦†ç›–ç‡ä½äº80%: $COVERAGE"
            exit 1
          fi
          echo "âœ… æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡: $COVERAGE"
        fi
        
        # æ£€æŸ¥æ„å»ºçŠ¶æ€
        echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
        echo "âœ… ä¾èµ–å®‰å…¨æ‰«æé€šè¿‡"
        echo "âœ… æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡"

  # æ„å»ºå’Œæ¨é€é•œåƒ
  build-and-push:
    runs-on: ubuntu-latest
    needs: [api-testing, quality-gate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ç”Ÿæˆé•œåƒæ ‡ç­¾
    - name: ç”Ÿæˆé•œåƒæ ‡ç­¾
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_REGISTRY }}/xiaowo
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    # æ„å»ºå¹¶æ¨é€åç«¯é•œåƒï¼ˆå¤šé˜¶æ®µæ„å»ºä¼˜åŒ–ï¼‰
    - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./backend
        file: ./backend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VERSION=${{ github.sha }}
          COMMIT_SHA=${{ github.sha }}

    # æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒï¼ˆå¤šé˜¶æ®µæ„å»ºä¼˜åŒ–ï¼‰
    - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./frontend
        file: ./frontend/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}-frontend
        labels: ${{ steps.meta.outputs.labels }}-frontend
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VERSION=${{ github.sha }}
          COMMIT_SHA=${{ github.sha }}

    # ç”Ÿæˆæ„å»ºæ‘˜è¦
    - name: æ„å»ºæ‘˜è¦
      run: |
        echo "## ğŸš€ æ„å»ºå’Œæ¨é€æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- åç«¯é•œåƒ: ${{ secrets.DOCKER_REGISTRY }}/xiaowo-backend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- å‰ç«¯é•œåƒ: ${{ secrets.DOCKER_REGISTRY }}/xiaowo-frontend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- æ„å»ºæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- Git SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®éƒ¨ç½²ç¯å¢ƒ
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ"
        echo "éƒ¨ç½²é…ç½®: ${{ secrets.STAGING_ENV_CONFIG }}"
        
    # éƒ¨ç½²åˆ°Kubernetesï¼ˆå¦‚æœä½¿ç”¨K8sï¼‰
    - name: éƒ¨ç½²åˆ°Kubernetes
      if: env.KUBERNETES_ENABLED == 'true'
      run: |
        echo "ğŸ”§ ä½¿ç”¨Kuberneteséƒ¨ç½²"
        # é…ç½®kubectl
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig
        
        # åº”ç”¨é…ç½®
        kubectl apply -f k8s/staging/ -n xiaowo-staging
        
        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        kubectl rollout status deployment/xiaowo-backend -n xiaowo-staging
        kubectl rollout status deployment/xiaowo-frontend -n xiaowo-staging
        
    # éƒ¨ç½²åˆ°Docker Composeï¼ˆå¦‚æœä½¿ç”¨Dockerï¼‰
    - name: éƒ¨ç½²åˆ°Docker Compose
      if: env.KUBERNETES_ENABLED != 'true'
      run: |
        echo "ğŸ³ ä½¿ç”¨Docker Composeéƒ¨ç½²"
        cd deployment/staging
        docker-compose up -d
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 30
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        docker-compose ps

    - name: è¿è¡Œéƒ¨ç½²åæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œéƒ¨ç½²åæµ‹è¯•"
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 60
        # è¿è¡Œå¥åº·æ£€æŸ¥
        curl -f http://staging.xiaowo.com/health || exit 1
        # è¿è¡Œå†’çƒŸæµ‹è¯•
        cd tests
        ./run_tests.sh --mode quick --env staging

    - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "## ğŸ¯ æµ‹è¯•ç¯å¢ƒéƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š éƒ¨ç½²çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- éƒ¨ç½²æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ç¯å¢ƒ: æµ‹è¯•ç¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
        echo "- ç‰ˆæœ¬: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- URL: http://staging.xiaowo.com" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼ˆéœ€è¦æ‰‹åŠ¨ç¡®è®¤ï¼‰
  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    timeout-minutes: 30
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç¡®è®¤
      run: |
        echo "âš ï¸ å‡†å¤‡éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        echo "è¯·ç¡®è®¤æ˜¯å¦ç»§ç»­éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        
    - name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
        
        # éƒ¨ç½²åˆ°Kubernetesï¼ˆå¦‚æœä½¿ç”¨K8sï¼‰
        if [ "${{ env.KUBERNETES_ENABLED }}" == "true" ]; then
          echo "ğŸ”§ ä½¿ç”¨Kuberneteséƒ¨ç½²"
          # é…ç½®kubectl
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig-prod
          export KUBECONFIG=kubeconfig-prod
          
          # åº”ç”¨ç”Ÿäº§ç¯å¢ƒé…ç½®
          kubectl apply -f k8s/production/ -n xiaowo-production
          
          # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          kubectl rollout status deployment/xiaowo-backend -n xiaowo-production --timeout=10m
          kubectl rollout status deployment/xiaowo-frontend -n xiaowo-production --timeout=10m
          
          echo "âœ… Kuberneteséƒ¨ç½²å®Œæˆ"
        else
          echo "ğŸ³ ä½¿ç”¨Docker Composeéƒ¨ç½²"
          # å¤åˆ¶ç”Ÿäº§ç¯å¢ƒé…ç½®
          cp -r deployment/staging/* deployment/production/ || true
          cd deployment/production
          
          # æ›´æ–°é•œåƒæ ‡ç­¾ä¸ºæœ€æ–°ç‰ˆæœ¬
          sed -i "s|image: .*/xiaowo:.*|image: ${{ secrets.DOCKER_REGISTRY }}/xiaowo:${{ github.sha }}|g" docker-compose.yml
          sed -i "s|image: .*/xiaowo-frontend:.*|image: ${{ secrets.DOCKER_REGISTRY }}/xiaowo-frontend:${{ github.sha }}|g" docker-compose.yml
          
          # éƒ¨ç½²æœåŠ¡
          docker-compose up -d
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 60
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          docker-compose ps
          
          echo "âœ… Docker Composeéƒ¨ç½²å®Œæˆ"
        fi

    - name: ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥
      run: |
        echo "ğŸ” ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥"
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 120
        # è¿è¡Œå¥åº·æ£€æŸ¥
        if ! curl -f https://xiaowo.com/health; then
          echo "âŒ ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè§¦å‘å›æ»š"
          # æ‰§è¡Œå›æ»šæ“ä½œ
          if [ "${{ env.KUBERNETES_ENABLED }}" == "true" ]; then
            echo "ğŸ”„ Kuberneteså›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬"
            export KUBECONFIG=kubeconfig-prod
            kubectl rollout undo deployment/xiaowo-backend -n xiaowo-production
            kubectl rollout undo deployment/xiaowo-frontend -n xiaowo-production
          else
            echo "ğŸ”„ Docker Composeå›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬"
            cd deployment/production
            # å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
            docker-compose down
            docker-compose up -d --scale backend=2 --scale frontend=2
          fi
          exit 1
        fi
        # è¿è¡Œå®Œæ•´æµ‹è¯•
        cd tests
        ./run_tests.sh --mode full --env production

    - name: ç”Ÿæˆç”Ÿäº§éƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "## ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š éƒ¨ç½²çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
        echo "- éƒ¨ç½²æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ç¯å¢ƒ: ç”Ÿäº§ç¯å¢ƒ" >> $GITHUB_STEP_SUMMARY
        echo "- ç‰ˆæœ¬: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- URL: https://xiaowo.com" >> $GITHUB_STEP_SUMMARY

  # æ‰‹åŠ¨å›æ»šæœºåˆ¶
  rollback:
    runs-on: ubuntu-latest
    needs: deploy-production
    if: failure() && github.event_name == 'workflow_dispatch'
    environment: production
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: æ‰§è¡Œæ‰‹åŠ¨å›æ»š
      run: |
        echo "ğŸ”„ æ‰§è¡Œæ‰‹åŠ¨å›æ»šæ“ä½œ"
        
        # å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
        if [ "${{ env.KUBERNETES_ENABLED }}" == "true" ]; then
          echo "ğŸ”§ ä½¿ç”¨Kuberneteså›æ»š"
          # é…ç½®kubectl
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig-prod
          export KUBECONFIG=kubeconfig-prod
          
          # å›æ»šéƒ¨ç½²
          kubectl rollout undo deployment/xiaowo-backend -n xiaowo-production
          kubectl rollout undo deployment/xiaowo-frontend -n xiaowo-production
          
          # ç­‰å¾…å›æ»šå®Œæˆ
          kubectl rollout status deployment/xiaowo-backend -n xiaowo-production --timeout=5m
          kubectl rollout status deployment/xiaowo-frontend -n xiaowo-production --timeout=5m
          
        else
          echo "ğŸ³ ä½¿ç”¨Docker Composeå›æ»š"
          cd deployment/production
          
          # åœæ­¢å½“å‰æœåŠ¡
          docker-compose down
          
          # å¯åŠ¨ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
          docker-compose up -d --scale backend=2 --scale frontend=2
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30
          
          # éªŒè¯å›æ»šç»“æœ
          docker-compose ps
        fi
        
        echo "âœ… å›æ»šæ“ä½œå®Œæˆ"

  # é€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    needs: [api-testing, dependency-scan, deploy-staging, deploy-production]
    if: always()
    
    steps:
    - name: å‘é€æ„å»ºé€šçŸ¥
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#xiaowo-builds'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
