name: ðŸ”§ Secretsé…ç½®æµ‹è¯•

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  test-secrets-config:
    runs-on: ubuntu-latest
    name: éªŒè¯Secretsé…ç½®
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: ðŸ” æ£€æŸ¥å¿…éœ€çš„Secrets
      run: |
        echo "ðŸ” å¼€å§‹æ£€æŸ¥GitHub Secretsé…ç½®..."
        
        # æ£€æŸ¥Dockeré…ç½®
        if [[ -z "${{ secrets.DOCKER_REGISTRY }}" ]]; then
          echo "âŒ DOCKER_REGISTRY æœªè®¾ç½®"
          exit 1
        else
          echo "âœ… DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}"
        fi
        
        if [[ -z "${{ secrets.DOCKER_USERNAME }}" ]]; then
          echo "âŒ DOCKER_USERNAME æœªè®¾ç½®"
          exit 1
        else
          echo "âœ… DOCKER_USERNAME å·²è®¾ç½®"
        fi
        
        if [[ -z "${{ secrets.DOCKER_PASSWORD }}" ]]; then
          echo "âŒ DOCKER_PASSWORD æœªè®¾ç½®"
          exit 1
        else
          echo "âœ… DOCKER_PASSWORD å·²è®¾ç½®"
        fi
        
        # æ£€æŸ¥Kubernetesé…ç½®
        if [[ -z "${{ secrets.KUBE_CONFIG }}" ]]; then
          echo "âŒ KUBE_CONFIG æœªè®¾ç½®"
          exit 1
        else
          echo "âœ… KUBE_CONFIG å·²è®¾ç½®"
        fi
        
        if [[ -z "${{ secrets.KUBE_CONFIG_PROD }}" ]]; then
          echo "âš ï¸  KUBE_CONFIG_PROD æœªè®¾ç½® (å¯é€‰)"
        else
          echo "âœ… KUBE_CONFIG_PROD å·²è®¾ç½®"
        fi
        
        # æ£€æŸ¥é€šçŸ¥é…ç½®
        if [[ -z "${{ secrets.SLACK_WEBHOOK }}" ]]; then
          echo "âš ï¸  SLACK_WEBHOOK æœªè®¾ç½® (å¯é€‰)"
        else
          echo "âœ… SLACK_WEBHOOK å·²è®¾ç½®"
        fi
        
        echo "ðŸŽ‰ Secretsé…ç½®æ£€æŸ¥å®Œæˆï¼"
    
    - name: ðŸ³ æµ‹è¯•Dockerç™»å½•
      run: |
        echo "ðŸ³ æµ‹è¯•Dockerç™»å½•..."
        
        # å°è¯•ç™»å½•Dockerä»“åº“
        if echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ secrets.DOCKER_REGISTRY }} -u ${{ secrets.DOCKER_USERNAME }} --password-stdin; then
          echo "âœ… Dockerç™»å½•æˆåŠŸ"
          
          # æ‹‰å–ä¸€ä¸ªæµ‹è¯•é•œåƒæ¥éªŒè¯è¿žæŽ¥
          docker pull hello-world
          echo "âœ… Dockerä»“åº“è¿žæŽ¥æ­£å¸¸"
        else
          echo "âŒ Dockerç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç "
          exit 1
        fi
    
    - name: â˜¸ï¸ æµ‹è¯•Kubernetesé…ç½®
      run: |
        echo "â˜¸ï¸ æµ‹è¯•Kubernetesé…ç½®..."
        
        # å®‰è£…kubectl
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubeconfig"
        chmod +x kubeconfig
        sudo mv kubeconfig /usr/local/bin/kubeconfig
        
        # è§£ç å¹¶æµ‹è¯•kubeconfig
        echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > kubeconfig-test.yaml
        export KUBECONFIG=kubeconfig-test.yaml
        
        # æµ‹è¯•kubectlè¿žæŽ¥
        if kubectl cluster-info; then
          echo "âœ… Kubernetesè¿žæŽ¥æ­£å¸¸"
          kubectl get nodes
        else
          echo "âŒ Kubernetesè¿žæŽ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥kubeconfig"
          exit 1
        fi
    
    - name: ðŸ“Š ç”Ÿæˆé…ç½®æŠ¥å‘Š
      run: |
        echo "ðŸ“Š ç”ŸæˆSecretsé…ç½®æŠ¥å‘Š..."
        
        cat > secrets-config-report.md << EOF
        # ðŸ”§ Secretsé…ç½®æµ‹è¯•æŠ¥å‘Š
        
        ## æµ‹è¯•æ—¶é—´
        $(date)
        
        ## é…ç½®çŠ¶æ€
        
        ### Dockeré…ç½®
        - âœ… DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
        - âœ… DOCKER_USERNAME: å·²è®¾ç½®
        - âœ… DOCKER_PASSWORD: å·²è®¾ç½®
        
        ### Kubernetesé…ç½®
        - âœ… KUBE_CONFIG: å·²è®¾ç½®
        - $([[ -z "${{ secrets.KUBE_CONFIG_PROD }}" ]] && echo "âš ï¸  KUBE_CONFIG_PROD: æœªè®¾ç½®" || echo "âœ… KUBE_CONFIG_PROD: å·²è®¾ç½®")
        
        ### é€šçŸ¥é…ç½®
        - $([[ -z "${{ secrets.SLACK_WEBHOOK }}" ]] && echo "âš ï¸  SLACK_WEBHOOK: æœªè®¾ç½®" || echo "âœ… SLACK_WEBHOOK: å·²è®¾ç½®")
        
        ## ä¸‹ä¸€æ­¥æ“ä½œ
        1. å¦‚æžœæ‰€æœ‰å¿…éœ€é¡¹éƒ½æ˜¾ç¤º âœ…ï¼Œè¯´æ˜Žé…ç½®æ­£ç¡®
        2. å¦‚æžœæœ‰ âŒ æ ‡è®°ï¼Œè¯·é‡æ–°é…ç½®å¯¹åº”çš„Secret
        3. å¯é€‰é¡¹ç›®(âš ï¸)å¯ä»¥ç¨åŽé…ç½®
        
        ## å¸¸è§é—®é¢˜
        - Dockerç™»å½•å¤±è´¥ï¼šæ£€æŸ¥ç”¨æˆ·åã€å¯†ç æˆ–ä»¤ç‰Œæ˜¯å¦æ­£ç¡®
        - Kubernetesè¿žæŽ¥å¤±è´¥ï¼šæ£€æŸ¥kubeconfigæ–‡ä»¶æ ¼å¼å’Œæƒé™
        EOF
        
        echo "ðŸ“‹ æŠ¥å‘Šå·²ç”Ÿæˆï¼šsecrets-config-report.md"