name: ç›‘æŽ§å’Œå‘Šè­¦

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯30åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: çŽ¯å¢ƒå¥åº·æ£€æŸ¥
      run: |
        echo "ðŸ” å¼€å§‹çŽ¯å¢ƒå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å¼€å‘çŽ¯å¢ƒ
        if curl -f -s http://dev.xiaowo.com/health > /dev/null; then
          echo "âœ… å¼€å‘çŽ¯å¢ƒå¥åº·"
        else
          echo "âŒ å¼€å‘çŽ¯å¢ƒå¼‚å¸¸"
          # å‘é€å‘Šè­¦
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ðŸš¨ å¼€å‘çŽ¯å¢ƒå¼‚å¸¸ï¼Œè¯·ç«‹å³æ£€æŸ¥ï¼"}' \
            ${{ secrets.SLACK_WEBHOOK }}
        fi
        
        # æ£€æŸ¥æµ‹è¯•çŽ¯å¢ƒ
        if curl -f -s http://staging.xiaowo.com/health > /dev/null; then
          echo "âœ… æµ‹è¯•çŽ¯å¢ƒå¥åº·"
        else
          echo "âŒ æµ‹è¯•çŽ¯å¢ƒå¼‚å¸¸"
          # å‘é€å‘Šè­¦
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"âš ï¸ æµ‹è¯•çŽ¯å¢ƒå¼‚å¸¸ï¼Œè¯·ç«‹å³æ£€æŸ¥ï¼"}' \
            ${{ secrets.SLACK_WEBHOOK }}
        fi
        
        # æ£€æŸ¥ç”Ÿäº§çŽ¯å¢ƒ
        if curl -f -s https://xiaowo.com/health > /dev/null; then
          echo "âœ… ç”Ÿäº§çŽ¯å¢ƒå¥åº·"
        else
          echo "âŒ ç”Ÿäº§çŽ¯å¢ƒå¼‚å¸¸"
          # å‘é€ç´§æ€¥å‘Šè­¦
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ðŸš¨ðŸš¨ðŸš¨ ç”Ÿäº§çŽ¯å¢ƒå¼‚å¸¸ï¼Œç´§æ€¥å¤„ç†ï¼"}' \
            ${{ secrets.SLACK_WEBHOOK }}
        fi
        
        # ç”Ÿæˆå¥åº·æŠ¥å‘Š
        echo "## ðŸ“Š çŽ¯å¢ƒå¥åº·æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "æ£€æŸ¥æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "å¼€å‘çŽ¯å¢ƒ: âœ… æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        echo "æµ‹è¯•çŽ¯å¢ƒ: âœ… æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        echo "ç”Ÿäº§çŽ¯å¢ƒ: âœ… æ­£å¸¸" >> $GITHUB_STEP_SUMMARY

  performance-monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ€§èƒ½ç›‘æŽ§æ£€æŸ¥
      run: |
        echo "ðŸ“ˆ å¼€å§‹æ€§èƒ½ç›‘æŽ§æ£€æŸ¥..."
        
        # æ£€æŸ¥å“åº”æ—¶é—´
        RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' http://staging.xiaowo.com/api/health)
        echo "æµ‹è¯•çŽ¯å¢ƒå“åº”æ—¶é—´: ${RESPONSE_TIME}s"
        
        # æ£€æŸ¥é”™è¯¯çŽ‡
        ERROR_COUNT=$(curl -s http://staging.xiaowo.com/api/metrics | jq -r '.error_count' 2>/dev/null || echo "0")
        echo "é”™è¯¯æ•°é‡: $ERROR_COUNT"
        
        # æ£€æŸ¥CPUå’Œå†…å­˜ä½¿ç”¨çŽ‡
        echo "CPUä½¿ç”¨çŽ‡: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')%"
        echo "å†…å­˜ä½¿ç”¨çŽ‡: $(free | grep Mem | awk '{printf("%.1f%%", $3/$2 * 100.0)}')"
        
        # ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        echo "## ðŸ“Š æ€§èƒ½ç›‘æŽ§æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "æ£€æŸ¥æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- å“åº”æ—¶é—´: ${RESPONSE_TIME}s" >> $GITHUB_STEP_SUMMARY
        echo "- é”™è¯¯æ•°é‡: $ERROR_COUNT" >> $GITHUB_STEP_SUMMARY
        echo "- CPUä½¿ç”¨çŽ‡: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')%" >> $GITHUB_STEP_SUMMARY
        echo "- å†…å­˜ä½¿ç”¨çŽ‡: $(free | grep Mem | awk '{printf("%.1f%%", $3/$2 * 100.0)}')" >> $GITHUB_STEP_SUMMARY
