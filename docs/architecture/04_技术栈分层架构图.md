# 小窝项目技术栈分层架构图

## 技术栈概述

小窝项目采用现代化的技术栈设计，严格遵循分层架构原则，确保系统的可维护性、可扩展性和高性能。技术选型基于MVP阶段的需求，同时预留未来扩展空间。

## 技术栈分层架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                             小窝技术栈分层架构                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │   表现层 (UI)   │  │   表现层 (UI)   │  │   表现层 (UI)   │  │   表现层 (UI)   │             │
│  │                │  │                │  │                │  │                │             │
│  │  Vue 3 + TS    │  │   移动端App    │  │   PWA应用      │  │  管理后台UI    │             │
│  │  TailwindCSS   │  │    (预留)       │  │   (预留)       │  │    (预留)       │             │
│  │  Pinia状态管理  │  │                │  │                │  │                │             │
│  │  Vue Router    │  │                │  │                │  │                │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                 通信层 (Communication)                                       │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │  │   HTTP/REST     │  │   WebSocket     │  │     SSE         │  │     WebRTC      │         │ │
│  │  │                │  │                │  │   (预留)        │  │   (预留)        │         │ │
│  │  │ - JSON格式      │  │ - 实时双向通信  │  │ - 服务器推送    │  │ - 音视频通话    │         │ │
│  │  │ - 状态码标准    │  │ - 心跳检测      │  │ - 通知消息      │  │ - 屏幕共享      │         │ │
│  │  │ - 参数校验      │  │ - 断线重连      │  │ - 实时状态      │  │ - 低延迟通信    │         │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                 网关层 (Gateway)                                             │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │  │    Nginx        │  │   负载均衡      │  │    安全代理     │  │    缓存代理     │         │ │
│  │  │                │  │                │  │                │  │                │         │ │
│  │  │ - 反向代理      │  │ - Upstream配置  │  │ - SSL/TLS终止   │  │ - 静态资源缓存  │         │ │
│  │  │ - 路由分发      │  │ - 健康检查      │  │ - 安全头设置    │  │ - Gzip压缩      │         │ │
│  │  │ - 限流控制      │  │ - 会话保持      │  │ - CORS策略      │  │ - 响应缓存      │         │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                 应用层 (Application)                                         │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                               Go后端服务 (单体应用)                                       │ │ │
│  │  │                                                                                         │ │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │ │ │
│  │  │  │  HTTP服务    │  │ WebSocket   │  │  业务逻辑   │  │  数据访问   │                   │ │ │
│  │  │  │             │  │   服务       │  │             │  │             │                   │ │ │
│  │  │  │ - Gin框架   │  │ - 连接管理   │  │ - 房间管理   │  │ - GORM ORM  │                   │ │ │
│  │  │  │ - 中间件     │  │ - 消息路由   │  │ - 同步逻辑   │  │ - 事务管理  │                   │ │ │
│  │  │  │ - 参数验证   │  │ - 广播机制   │  │ - 权限控制   │  │ - 连接池    │                   │ │ │
│  │  │  │ - 错误处理   │  │ - 心跳检测   │  │ - 业务校验   │  │ - 迁移工具  │                   │ │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                   │ │ │
│  │  │                                                                                         │ │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │ │ │
│  │  │  │   核心服务   │  │   辅助服务   │  │   工具类    │  │   配置管理   │                   │ │ │
│  │  │  │             │  │             │  │             │  │             │                   │ │ │
│  │  │  │ - 房间服务   │  │ - 日志服务   │  │ - UUID生成   │  │ - Viper配置  │                   │ │ │
│  │  │  │ - 用户服务   │  │ - 监控服务   │  │ - 时间工具   │  │ - 环境变量   │                   │ │ │
│  │  │  │ - 同步服务   │  │ - 缓存服务   │  │ - 加密工具   │  │ - 功能开关   │                   │ │ │
│  │  │  │ - 消息服务   │  │ - 任务调度   │  │ - 校验工具   │  │ - 错误码配置│                   │ │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                   │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                 中间件层 (Middleware)                                        │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │  │   鉴权中间件     │  │   限流中间件     │  │   日志中间件     │  │   CORS中间件     │         │ │
│  │  │                │  │                │  │                │  │                │         │ │
│  │  │ - 会话验证      │  │ - 频率限制      │  │ - 请求日志      │  │ - 跨域处理      │         │ │
│  │  │ - 权限检查      │  │ - 并发控制      │  │ - 性能监控      │  │ - 预检请求      │         │ │
│  │  │ - Token解析    │  │ - 流量控制      │  │ - 错误日志      │  │ - 安全策略      │         │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                 数据层 (Data)                                                │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │  │   主数据库       │  │   缓存层        │  │   消息队列      │  │   文件存储      │         │ │
│  │  │                │  │                │  │                │  │                │         │ │
│  │  │  SQLite 3.x    │  │   (预留Redis)   │  │   (预留RabbitMQ)│  │   (预留OSS)     │         │ │
│  │  │                │  │                │  │                │  │                │         │ │
│  │  │ - ACID特性      │  │ - 会话缓存      │  │ - 消息持久化    │  │ - 静态文件      │         │ │
│  │  │ - 事务支持      │  │ - 状态缓存      │  │ - 异步处理      │  │ - 用户头像      │         │ │
│  │  │ - 并发控制      │  │ - 配置缓存      │  │ - 任务队列      │  │ - 房间缩略图    │         │ │
│  │  │ - 备份恢复      │  │ - 临时数据      │  │ - 事件总线      │  │ - 日志文件      │         │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                 基础设施层 (Infrastructure)                                 │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │  │   操作系统       │  │   容器化        │  │   监控系统      │  │   备份存储      │         │ │
│  │  │                │  │                │  │                │  │                │         │ │
│  │  │  Linux Ubuntu   │  │  Docker容器     │  │ - 应用监控      │  │ - 数据库备份    │         │ │
│  │  │                │  │                │  │ - 性能监控      │  │ - 配置备份      │         │ │
│  │  │ - 系统服务      │  │ - 镜像管理      │  │ - 日志收集      │  │ - 文件备份      │         │ │
│  │  │ - 网络配置      │  │ - 容器编排      │  │ - 告警通知      │  │ - 异地备份      │         │ │
│  │  │ - 安全配置      │  │ - 健康检查      │  │ - 指标收集      │  │ - 恢复策略      │         │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                   │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## 技术栈详细说明

### 1. 表现层 (Presentation Layer)

#### 前端技术栈
- **Vue 3**: 
  - 组合式API，更好的TypeScript支持
  - 响应式数据绑定
  - 组件化开发
- **TypeScript**: 
  - 类型安全，减少运行时错误
  - 更好的IDE支持
  - 代码可维护性提升
- **TailwindCSS**: 
  - 原子化CSS框架
  - 响应式设计
  - 自定义主题支持
- **Pinia**: 
  - Vue 3官方推荐状态管理
  - TypeScript原生支持
  - 模块化状态管理

#### 技术选型理由
- **Vue 3 vs React**: 学习曲线平缓，中文文档丰富
- **TypeScript vs JavaScript**: 提供类型检查，减少bug
- **TailwindCSS vs 原生CSS**: 快速开发，样式一致性

### 2. 通信层 (Communication Layer)

#### HTTP/REST API
- **JSON格式**: 轻量级数据交换格式
- **状态码标准**: HTTP标准状态码
- **参数校验**: 前后端双重校验

#### WebSocket
- **实时双向通信**: 支持视频同步播放
- **心跳检测**: 维持连接稳定性
- **断线重连**: 自动恢复机制

### 3. 网关层 (Gateway Layer)

#### Nginx配置
```nginx
server {
    listen 443 ssl http2;
    server_name xiaowo.example.com;
    
    # SSL配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # HTTP到HTTPS重定向
    return 301 https://$server_name$request_uri;
}

server {
    listen 80;
    server_name xiaowo.example.com;
    return 301 https://$server_name$request_uri;
}

# WebSocket代理
location /ws/ {
    proxy_pass http://backend:8080;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
}

# 静态资源
location /static/ {
    root /var/www;
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 4. 应用层 (Application Layer)

#### Go后端服务
- **Gin框架**: 
  - 高性能HTTP web框架
  - 中间件生态丰富
  - 零拷贝路由
- **GORM**: 
  - 功能强大的ORM框架
  - 支持多种数据库
  - 自动迁移工具
- **WebSocket**: 
  - 原生WebSocket支持
  - 连接池管理
  - 消息广播机制

#### 核心组件
```go
// 主要依赖包
require (
    github.com/gin-gonic/gin v1.9.1
    gorm.io/driver/sqlite v1.5.4
    gorm.io/gorm v1.25.5
    github.com/gorilla/websocket v1.5.0
    github.com/spf13/viper v1.18.2
    github.com/google/uuid v1.4.0
)
```

### 5. 中间件层 (Middleware Layer)

#### 鉴权中间件
```go
func AuthMiddleware() gin.HandlerFunc {
    return gin.HandlerFunc(func(c *gin.Context) {
        token := c.GetHeader("Authorization")
        if token == "" {
            c.JSON(401, gin.H{"error": "unauthorized"})
            c.Abort()
            return
        }
        // 验证token逻辑
        c.Set("user_id", extractUserID(token))
        c.Next()
    })
}
```

#### 限流中间件
```go
func RateLimitMiddleware() gin.HandlerFunc {
    limiter := rate.NewLimiter(rate.Every(time.Second), 100)
    return gin.HandlerFunc(func(c *gin.Context) {
        if !limiter.Allow() {
            c.JSON(429, gin.H{"error": "too many requests"})
            c.Abort()
            return
        }
        c.Next()
    })
}
```

### 6. 数据层 (Data Layer)

#### SQLite数据库
- **ACID特性**: 确保数据一致性
- **事务支持**: 支持复杂业务操作
- **轻量级**: 无需独立数据库服务
- **备份恢复**: 简单文件操作

#### 数据表设计
```sql
-- 核心表结构
CREATE TABLE rooms (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    creator_session_id TEXT NOT NULL,
    is_private INTEGER DEFAULT 0,
    room_password TEXT,
    max_users INTEGER DEFAULT 50,
    settings TEXT,
    playback_state TEXT,
    version INTEGER DEFAULT 0,
    status TEXT DEFAULT 'active',
    last_active_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 7. 基础设施层 (Infrastructure Layer)

#### 容器化部署
```dockerfile
# Dockerfile示例
FROM golang:1.21-alpine AS builder
WORKDIR /app
COPY . .
RUN go build -o xiaowo main.go

FROM alpine:latest
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/xiaowo .
CMD ["./xiaowo"]
```

#### Docker Compose
```yaml
version: '3.8'
services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/ssl/certs
    depends_on:
      - backend

  backend:
    build: ./backend
    ports:
      - "8080:8080"
    volumes:
      - ./data:/app/data
    environment:
      - DB_PATH=/app/data/xiaowo.db
```

## 技术选型原则

### 1. MVP优先原则
- 选择成熟稳定的技术栈
- 避免过度工程化
- 快速迭代开发

### 2. 性能优先原则
- Go语言高性能特性
- Nginx反向代理优化
- 数据库查询优化

### 3. 可维护性原则
- 代码结构清晰
- 技术文档完善
- 测试覆盖率高

### 4. 可扩展性原则
- 模块化设计
- 接口标准化
- 预留扩展接口

### 5. 安全性原则
- 输入验证严格
- 权限控制精细
- 数据传输加密

---

**版本**: v1.0  
**最后更新**: 2025-12-30  
**作者**: 系统架构师  
**状态**: 已完成