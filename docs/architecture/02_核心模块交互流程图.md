# 小窝项目核心模块间交互流程图

## 交互流程概述

本文档展示小窝系统中各个核心模块之间的交互关系，包括房间管理、用户会话、WebSocket连接、同步逻辑等关键业务流程。

## 1. 创建房间流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端   │    │ HTTP API    │    │ 房间服务    │    │ 数据访问层  │    │ 数据库  │
└────┬────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘
     │                │                │                │                │
     │ POST /api/v1/rooms│               │                │                │
     │----------------->│                │                │                │
     │                │ ValidateRequest │                │                │
     │                │---------------->│                │                │
     │                │                │ CreateRoom      │                │
     │                │                │---------------->│                │
     │                │                │                │ INSERT INTO rooms│
     │                │                │                │---------------->│
     │                │                │                │                │◄───────┐
     │                │                │                │                │房间创建成功
     │                │                │                │                │
     │                │                │ RoomCreated     │                │
     │                │                │<----------------│                │
     │                │                │ AuditLog        │                │
     │                │                │---------------->│                │
     │                │                │                 │ INSERT INTO audit_logs│
     │                │                │                 │---------------->│
     │                │ RoomResponse    │                 │                 │
     │                │<----------------│                 │                 │
     │ RoomCreated    │                │                 │                 │
     │<----------------│                │                 │                 │
     │                │                │                 │                 │
┌────┴────┐    ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐    └────┬────┘
│ 客户端   │    │ HTTP API    │    │ 房间服务    │    │ 数据访问层  │    │ 数据库  │
└─────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘
```

## 2. 加入房间流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端   │    │ HTTP API    │    │ 房间服务    │    │ WebSocket   │    │ 同步服务    │    │ 数据库  │
└────┬────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘
     │                │                │                │                │                │
     │ POST /ws/v1/room/{id}│           │                │                │                │
     │----------------->│                │                │                │                │
     │                │ UpgradeToWS    │                │                │                │
     │                │---------------->│                │                │                │
     │                │                │ ValidateJoin   │                │                │
     │                │                │---------------->│                │                │
     │                │                │                │ LoadRoomState │                │
     │                │                │                │-------------->│                │
     │                │                │                │                │ SELECT * FROM rooms│
     │                │                │                │                │---------------->│
     │                │                │                │                │                │◄─────┐
     │                │                │                │                │                │
     │                │                │ AddMember      │                │                │
     │                │                │------------------------------------------------>│
     │                │                │                │                │ INSERT INTO room_members│
     │                │                │                │                │---------------->│
     │                │                │                │                │                │◄─────┐
     │                │                │                │ SyncInit       │                │
     │                │                │                │------------------------------------------------>│
     │                │                │                │                │ GetCurrentState│
     │                │                │                │                │--------------->│
     │                │                │                │                │ SELECT playback_state│
     │                │                │                │                │---------------->│
     │                │                │                │                │                │◄─────┐
     │                │                │                │ BroadcastJoin  │                │
     │                │                │                │<------------------------------------------------│
     │                │                │                │                │                │
     │                │ JoinResponse   │                │                │                │
     │                │<----------------│                │                │                │
     │ JoinSuccess    │                │                │                │                │
     │<----------------│                │                │                │                │
     │                │                │                │                │                │
┌────┴────┐    ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐    └────┬────┘
│ 客户端   │    │ HTTP API    │    │ 房间服务    │    │ WebSocket   │    │ 同步服务    │    │ 数据库  │
└─────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘
```

## 3. 视频同步播放流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端A  │    │ WebSocket   │    │ 同步服务    │    │ WebSocket   │    │ 客户端B │
└────┬────┘    │   Hub       │    │            │    │   Hub       │    └────┬────┘
     │         └──────┬──────┘    └──────┬──────┘    └──────┬──────┘         │
     │                │                │                │                │
     │ Sync Request   │                │                │                │
     │ (timestamp=100)│                │                │                │
     │---------------->│                │                │                │
     │                │ RouteSync      │                │                │
     │                │---------------->│                │                │
     │                │                │ ValidateSync   │                │
     │                │                │---------------->│                │
     │                │                │                │ BroadcastSync │
     │                │                │                │<---------------│
     │                │                │                │                │
     │                │                │                │ Sync Response  │
     │                │                │                │(timestamp=100) │
     │                │                │                │<---------------│
     │                │                │                │                │
     │                │ ForwardSync    │                │                │
     │                │<--------------------------------------------------│
     │                │                │                │                │
     │ Sync Response  │                │                │                │
     │(timestamp=100) │                │                │                │
     │<----------------│                │                │                │
     │                │                │                │                │
     │                │ UpdatePlayback │                │                │
     │                │---------------->│                │                │
     │                │                │ SaveState       │                │
     │                │                │---------------->│                │
     │                │                │                │ UPDATE rooms SET│
     │                │                │                │ playback_state=│
     │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │                │                │
     │                │ SyncComplete   │                │                │
     │                │<----------------│                │                │
     │                │                │                │                │
┌────┴────┐    ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐    └────┬────┘
│ 客户端A  │    │ WebSocket   │    │ 同步服务    │    │ WebSocket   │    │ 客户端B │
└─────────┘    │   Hub       │    │            │    │   Hub       │    └─────────┘
               └─────────────┘    └─────────────┘    └─────────────┘
```

## 4. 异常处理流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端   │    │ WebSocket   │    │ 同步服务    │    │ 中间件服务  │    │ 监控服务 │
└────┬────┘    │   Hub       │    │            │    │            │    │         │
     │         └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘
     │                │                │                │                │
     │ Sync Request   │                │                │                │
     │---------------->│                │                │                │
     │                │ RouteSync      │                │                │
     │                │---------------->│                │                │
     │                │                │ ProcessSync    │                │
     │                │                │---------------->│                │
     │                │                │                │ ValidateParams │
     │                │                │                │---------------->│
     │                │                │                │ Error: Invalid │
     │                │                │                │<----------------│
     │                │                │ ErrorResponse  │                │
     │                │                │<------------------------------------------------│
     │                │                │                │                │
     │                │ HandleError    │                │                │
     │                │------------------------------------------------>│
     │                │                │                │ LogError       │
     │                │                │                │------------------------------------------------>│
     │                │                │                │                │ INSERT INTO audit_logs│
     │                │                │                │                │---------------->│
     │                │                │                │                │                │
     │                │ ErrorResponse  │                │                │                │
     │                │<------------------------------------------------│
     │                │                │                │                │
     │ ErrorResponse  │                │                │                │
     │<----------------│                │                │                │
     │                │                │                │                │
┌────┴────┐    ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐    └────┬────┘
│ 客户端   │    │ WebSocket   │    │ 同步服务    │    │ 中间件服务  │    │ 监控服务 │
└─────────┘    │   Hub       │    │            │    │            │    │         │
               └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘
```

## 5. 房间管理流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端   │    │ HTTP API    │    │ 房间服务    │    │ 定时任务    │    │ 数据库  │
└────┬────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘
     │                │                │                │                │
     │ GET /api/v1/rooms│               │                │                │
     │----------------->│                │                │                │
     │                │ GetRooms       │                │                │
     │                │------------------------------------------------>│
     │                │                │                │ CheckInactive │
     │                │                │                │------------------------------------------------>│
     │                │                │                │ SELECT * FROM rooms│
     │                │                │                │ WHERE last_active_at <│
     │                │                │                │ CURRENT_TIMESTAMP - 1H│
     │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │                │ DeleteInactive │
     │                │                │                │------------------------------------------------>│
     │                │                │                │ DELETE FROM rooms│
     │                │                │                │ WHERE status='inactive'│
     │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │ LoadActiveRooms│                │
     │                │                │<------------------------------------------------│
     │                │                │                │ SELECT * FROM rooms│
     │                │                │                │ WHERE status='active'│
     │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │ RoomsResponse  │                │                │
     │                │<------------------------------------------------│
     │                │                │                │                │
     │ RoomsList      │                │                │                │
     │<----------------│                │                │                │
     │                │                │                │                │
┌────┴────┐    ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐    └────┬────┘
│ 客户端   │    │ HTTP API    │    │ 房间服务    │    │ 定时任务    │    │ 数据库  │
└─────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘
```

## 模块交互规则

### 1. 同步交互规则
- **HTTP API**: 同步请求-响应模式，用于房间管理操作
- **WebSocket**: 异步消息传递，用于实时同步
- **数据访问**: 事务性操作，确保数据一致性

### 2. 错误处理规则
- **向上传递**: 错误信息逐层向上传递
- **日志记录**: 所有异常操作必须记录审计日志
- **用户友好**: 错误信息对用户友好，对技术细节屏蔽

### 3. 性能优化规则
- **批量操作**: 支持批量房间操作减少数据库访问
- **连接复用**: WebSocket连接池复用机制
- **缓存策略**: 频繁访问数据使用缓存

### 4. 安全规则
- **权限验证**: 所有操作都需要权限验证
- **会话管理**: 基于会话的访问控制
- **数据校验**: 输入参数严格校验

---

**版本**: v1.0  
**最后更新**: 2025-12-30  
**作者**: 系统架构师  
**状态**: 已完成