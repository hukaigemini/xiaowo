# 小窝项目完整架构设计文档

## 文档信息
- **项目名称**: 小窝同步观影平台
- **版本**: v1.0
- **创建日期**: 2025-12-30
- **文档状态**: 完整版

## 目录
1. [执行摘要](#执行摘要)
2. [系统整体架构图](#系统整体架构图)
3. [核心模块交互流程图](#核心模块交互流程图)
4. [数据流程图](#数据流程图)
5. [技术栈分层架构图](#技术栈分层架构图)
6. [部署架构图](#部署架构图)
7. [关键组件详细设计说明](#关键组件详细设计说明)
8. [架构设计总结](#架构设计总结)

---

## 执行摘要

本文档提供了小窝同步观影平台的完整架构设计，基于"Phase 1: 左移评审"的工作流程，经过技术可行性分析、NFR（非功能性需求）评估和风险识别后，输出完整的系统架构蓝图。

**核心设计原则**：
- **MVP优先**：快速迭代，最小可行产品先行
- **单体架构**：MVP阶段拒绝微服务过度设计
- **Schema First**：数据库设计先行于业务逻辑
- **NFR前置**：容量、可用性、安全合规要求前置
- **开发体验优先**：清晰的目录结构和API规范

**技术栈选择**：
- **后端**: Go + Gin框架
- **数据库**: SQLite (MVP阶段) / PostgreSQL (生产)
- **前端**: HTML + Tailwind CSS + 原生JavaScript
- **实时通信**: WebSocket
- **部署**: Docker + Nginx

---

## 系统整体架构图

### 1.1 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层 (Client Layer)                    │
├─────────────────────────────────────────────────────────────────┤
│  Web浏览器客户端           │  移动端浏览器        │  桌面端浏览器    │
│  ├─ 首页 (index.html)      │  ├─ 响应式布局       │  ├─ PWA支持      │
│  ├─ 房间页面 (room.html)   │  ├─ 触摸优化         │  ├─ 原生体验      │
│  ├─ 播放器组件             │  ├─ 自适应UI         │  ├─ 离线缓存      │
│  └─ WebSocket连接          │  └─ 移动优化         │  └─ 通知支持      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     反向代理层 (Proxy Layer)                     │
├─────────────────────────────────────────────────────────────────┤
│  Nginx (生产) / Caddy (开发)                                    │
│  ├─ 静态文件服务                                                     │
│  ├─ SSL终止                                                         │
│  ├─ 请求限流                                                         │
│  ├─ GZIP压缩                                                        │
│  └─ 安全头设置                                                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      应用层 (Application Layer)                  │
├─────────────────────────────────────────────────────────────────┤
│  Go Backend API Server                                          │
│  ├─ HTTP/REST API (Gin框架)                                       │
│  ├─ WebSocket Hub (实时同步)                                      │
│  ├─ 业务逻辑层                                                      │
│  │  ├─ 房间管理服务                                                 │
│  │  ├─ 用户会话服务                                                 │
│  │  ├─ 播放控制服务                                                 │
│  │  └─ 实时同步服务                                                 │
│  ├─ 中间件层                                                        │
│  │  ├─ 认证中间件                                                   │
│  │  ├─ 限流中间件                                                   │
│  │  ├─ 日志中间件                                                   │
│  │  └─ 异常处理中间件                                               │
│  └─ 数据访问层                                                      │
│     ├─ 数据库操作 (GORM)                                           │
│     ├─ 缓存管理                                                     │
│     └─ 消息队列                                                     │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据层 (Data Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│  SQLite (开发) / PostgreSQL (生产)                              │
│  ├─ 核心业务数据                                                    │
│  │  ├─ rooms (房间信息)                                            │
│  │  ├─ user_sessions (用户会话)                                    │
│  │  ├─ room_members (房间成员)                                     │
│  │  ├─ playback_states (播放状态)                                  │
│  │  ├─ sync_messages (同步消息)                                    │
│  │  └─ room_activities (活动日志)                                  │
│  ├─ 数据一致性保障                                                  │
│  │  ├─ 外键约束                                                    │
│  │  ├─ 事务边界                                                    │
│  │  └─ 乐观锁版本控制                                              │
│  └─ 性能优化                                                        │
│     ├─ 索引优化策略                                                │
│     ├─ 查询优化                                                    │
│     └─ 连接池管理                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 架构说明

**用户层**：
- 支持多端浏览器访问，提供统一的用户体验
- 响应式设计适配移动端和桌面端
- 原生WebSocket实现实时通信

**反向代理层**：
- Nginx处理静态文件和SSL终止
- 实现请求限流和安全防护
- 开发环境使用Caddy简化配置

**应用层**：
- 基于Go + Gin的高性能后端服务
- 模块化业务逻辑，易于维护和扩展
- 完善的中间件体系处理横切关注点

**数据层**：
- SQLite作为开发数据库，PostgreSQL作为生产数据库
- 完整的数据约束和索引优化
- 支持数据一致性和性能优化

---

## 核心模块交互流程图

### 2.1 房间创建流程

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client    │     │   Backend    │     │  SQLite DB  │     │  WebSocket  │
│   (用户)     │     │   (API)      │     │  (数据库)    │     │    Hub      │
└──────┬──────┘     └──────┬───────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                  │
       │ POST /rooms       │                   │                  │
       │ {name, media_url} │                   │                  │
       │------------------>│                   │                  │
       │                   │ 1. 验证参数       │                  │
       │                   │ 2. 生成房间ID     │                  │
       │                   │ 3. 创建房间记录   │                  │
       │                   │----------------->│ INSERT rooms     │
       │                   │                  │----------------->│
       │                   │                  │<-SQLite OK-------│
       │                   │ 4. 创建播放状态  │                  │
       │                   │----------------->│ INSERT playback  │
       │                   │                  │----------------->│
       │                   │                  │<-SQLite OK-------│
       │                   │ 5. 记录活动日志  │                  │
       │                   │----------------->│ INSERT activity  │
       │                   │                  │----------------->│
       │                   │                  │<-SQLite OK-------│
       │                   │ 6. 广播房间创建  │                  │ 广播房间创建消息
       │                   │----------------->│----------------->│----------------->│
       │                   │ 7. 记录操作日志  │                  │              记录成功
       │                   │----------------->│----------------->│----------------->│
       │                   │              ←--│-- 201 Created --│-- 房间ID: 8XA92B --│
       │<------------------│              ←--│-- 房间对象数据 --│-- 播放状态 --│
       │ 房间创建成功       │                   │                  │
       │ 房间ID: 8XA92B     │                   │                  │
```

### 2.2 实时同步流程

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client A  │     │   Backend    │     │  SQLite DB  │     │  WebSocket  │
│  (主持人)    │     │   (API)      │     │  (数据库)    │     │    Hub      │
└──────┬──────┘     └──────┬───────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                  │
       │ 1. 播放操作        │                   │                  │
       │ play() at 1:30    │                   │                  │
       │------------------>│                   │                  │
       │                   │ 2. 权限验证       │                  │
       │                   │ 3. 更新播放状态   │                  │
       │                   │----------------->│ UPDATE playback  │
       │                   │                  │----------------->│
       │                   │                  │<-SQLite OK-------│
       │                   │ 4. 记录同步消息   │                  │
       │                   │----------------->│ INSERT message   │
       │                   │                  │----------------->│
       │                   │                  │<-SQLite OK-------│
       │                   │ 5. 广播播放状态   │                  │
       │                   │----------------->│----------------->│ PLAY_BROADCAST
       │                   │                  │              ←--│--同步消息
       │              ←--操作确认--│              ←--所有其他成员--│              ←--│--更新播放
       │                   │                   │              同步播放
       │                   │                   │                  │
       │                   │                   │                  │
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client B  │     │   Client C   │     │   Client D  │     │   Client E  │
│  (参与者1)   │     │  (参与者2)    │     │  (参与者3)   │     │  (参与者4)   │
└──────┬──────┘     └──────┬───────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                  │
       │ ←--同步播放--      │ ←--同步播放--      │ ←--同步播放--      │ ←--同步播放--
       │ play() at 1:30    │ play() at 1:30    │ play() at 1:30    │ play() at 1:30
       │                   │                   │                  │
```

---

## 数据流程图

### 3.1 用户会话管理数据流

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client    │     │   Backend    │     │  SQLite DB  │     │  Cache      │
│  (浏览器)    │     │   (API)      │     │  (数据库)    │     │  (内存)     │
└──────┬──────┘     └──────┬───────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                  │
       │ 1. 创建会话        │                   │                  │
       │ POST /sessions    │                   │                  │
       │------------------>│                   │                  │
       │                   │ 2. 验证参数       │                  │
       │                   │ 3. 生成会话ID     │                  │
       │                   │----------------->│ INSERT session   │
       │                   │                  │----------------->│
       │                   │                  │<-session_id------│
       │                   │ 4. 写入缓存       │                  │
       │                   │----------------->│ SET cache        │
       │                   │                  │----------------->│
       │                   │              ←--│-- 201 Created --│-- 会话数据 --
       │<------------------│              ←--│-- 会话对象 ------
       │ 会话创建成功       │                   │                  │
       │ 会话ID: xxx        │                   │                  │
       │                   │                   │                  │
       │ 2. 加入房间        │                   │                  │
       │ POST /rooms/...   │                   │                  │
       │------------------>│                   │                  │
       │                   │ 3. 更新会话       │                  │
       │                   │----------------->│ UPDATE session   │
       │                   │                  │----------------->│
       │                   │                  │<-SQLite OK-------│
       │                   │ 4. 更新缓存       │                  │
       │                   │----------------->│ SET cache        │
       │                   │                  │----------------->│
       │                   │              ←--│-- 201 Created --
       │<------------------│              ←--│-- 房间信息 ------
       │ 加入房间成功       │                   │                  │
       │                   │                   │                  │
```

### 3.2 实时同步数据流

```
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client    │     │   Backend    │     │  SQLite DB  │     │  WebSocket  │
│  (发送方)    │     │   (API)      │     │  (数据库)    │     │    Hub      │
└──────┬──────┘     └──────┬───────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                  │
       │ 1. WebSocket消息   │                   │                  │
       │ {                 │                   │                  │
       │   type: "play",   │                   │                  │
       │   time: 90,       │                   │                  │
       │   room_id: "xxx"  │                   │                  │
       │ }                 │                   │                  │
       │<==================│                   │                  │
       │                   │ 2. 消息验证       │                  │
       │                   │----------------->│                  │
       │                   │ 3. 权限检查       │                  │
       │                   │----------------->│                  │
       │                   │ 4. 持久化消息     │                  │
       │                   │----------------->│ INSERT message   │
       │                   │                  │----------------->│
       │                   │                  │<-message_id------│
       │                   │ 5. 更新播放状态   │                  │
       │                   │----------------->│ UPDATE playback  │
       │                   │                  │----------------->│
       │                   │                  │<-SQLite OK-------│
       │                   │ 6. 广播消息       │                  │
       │                   │----------------->│----------------->│ BROADCAST
       │                   │                  │              ←--│--房间内所有用户
       │                   │                  │                  │
       │                   │                  │                  │
┌─────────────┐     ┌──────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client 2  │     │   Client 3   │     │   Client N  │     │   Monitoring│
│  (接收方1)   │     │  (接收方2)    │     │  (接收方N)   │     │   System    │
└──────┬──────┘     └──────┬───────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │                  │
       │ ←--播放消息--      │ ←--播放消息--      │ ←--播放消息--      │
       │ {                 │ {                 │ {                 │
       │   type: "play",   │   type: "play",   │   type: "play",   │
       │   time: 90,       │   time: 90,       │   time: 90,       │
       │   timestamp: ...  │   timestamp: ...  │   timestamp: ...  │
       │ }                 │ }                 │ }                 │
       │                   │                   │                   │
       │ 7. 播放器同步      │ 7. 播放器同步      │ 7. 播放器同步      │
       │ play() at 90      │ play() at 90      │ play() at 90      │
       │                   │                   │                   │
       │                   │                   │              ←--│--性能监控
       │                   │                   │              ←--│--消息统计
       │                   │                   │              ←--│--延迟分析
```

---

## 技术栈分层架构图

### 4.1 技术栈层次结构

```
┌─────────────────────────────────────────────────────────────────┐
│                        表现层 (UI Layer)                        │
├─────────────────────────────────────────────────────────────────┤
│  浏览器渲染引擎                                                     │
│  ├─ HTML5 + CSS3                                                 │
│  ├─ JavaScript ES6+                                              │
│  ├─ Tailwind CSS (原子化CSS)                                     │
│  ├─ WebSocket API                                                │
│  └─ Media APIs (HTML5 Video)                                     │
│                                                                  │
│  开发工具链                                                       │
│  ├─ 前端构建: Vite/Webpack                                       │
│  ├─ 代码检查: ESLint + Prettier                                  │
│  ├─ 样式处理: PostCSS + Autoprefixer                             │
│  └─ 资源优化: 图片压缩 + 字体优化                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     通信层 (Communication Layer)                 │
├─────────────────────────────────────────────────────────────────┤
│  HTTP/REST API                                                   │
│  ├─ 协议: HTTP/1.1 + HTTP/2                                     │
│  ├─ 序列化: JSON                                                │
│  ├─ 状态码: 标准HTTP状态码                                      │
│  └─ 认证: Bearer Token                                          │
│                                                                  │
│  WebSocket (实时通信)                                            │
│  ├─ 协议: RFC 6455                                              │
│  ├─ 消息格式: JSON                                              │
│  ├─ 心跳检测: Ping/Pong                                         │
│  └─ 断线重连: 自动重连机制                                      │
│                                                                  │
│  反向代理                                                         │
│  ├─ Nginx (生产环境)                                            │
│  ├─ Caddy (开发环境)                                            │
│  ├─ SSL终止                                                     │
│  ├─ 静态文件服务                                               │
│  └─ 请求限流                                                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     网关层 (Gateway Layer)                      │
├─────────────────────────────────────────────────────────────────┤
│  API网关功能                                                     │
│  ├─ 路由分发                                                   │
│  ├─ 负载均衡 (开发环境单节点)                                  │
│  ├─ 限流控制                                                   │
│  ├─ 安全防护                                                   │
│  └─ 监控日志                                                   │
│                                                                  │
│  中间件组件                                                       │
│  ├─ CORS处理                                                   │
│  ├─ 请求日志                                                   │
│  ├─ 异常捕获                                                   │
│  └─ 性能监控                                                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     应用层 (Application Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│  Go Web框架 (Gin)                                               │
│  ├─ HTTP路由处理                                               │
│  ├─ 中间件机制                                                 │
│  ├─ 参数绑定与验证                                             │
│  ├─ 响应格式化                                                 │
│  └─ 错误处理                                                   │
│                                                                  │
│  业务逻辑组件                                                     │
│  ├─ 房间管理服务                                               │
│  ├─ 用户会话服务                                               │
│  ├─ 播放控制服务                                               │
│  ├─ 实时同步服务                                               │
│  └─ 消息广播服务                                               │
│                                                                  │
│  数据访问层                                                       │
│  ├─ ORM: GORM                                                  │
│  ├─ 连接池管理                                                 │
│  ├─ 事务管理                                                   │
│  └─ 查询优化                                                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                     中间件层 (Middleware Layer)                  │
├─────────────────────────────────────────────────────────────────┤
│  横切关注点处理                                                   │
│  ├─ 认证授权中间件                                             │
│  ├─ 请求限流中间件                                             │
│  ├─ 日志记录中间件                                             │
│  ├─ 异常处理中间件                                             │
│  ├─ 性能监控中间件                                             │
│  └─ 安全防护中间件                                             │
│                                                                  │
│  工具库                                                           │
│  ├─ 日志: zap + lumberjack                                      │
│  ├─ 配置: viper                                                │
│  ├─ UUID: uuid                                                 │
│  ├─ JSON处理: jsoniter                                         │
│  └─ 时间处理: carbon                                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据层 (Data Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│  关系型数据库                                                     │
│  ├─ 开发: SQLite                                               │
│  ├─ 生产: PostgreSQL                                           │
│  ├─ 连接池: pgxpool / sql.DB                                   │
│  ├─ 迁移: GORM AutoMigrate                                     │
│  └─ 备份: 自动备份策略                                         │
│                                                                  │
│  缓存 (可选)                                                     │
│  ├─ 内存缓存 (开发)                                            │
│  ├─ Redis (生产)                                              │
│  ├─ 缓存策略: LRU + TTL                                        │
│  └─ 缓存更新: 写穿/写回                                        │
│                                                                  │
│  文件存储                                                         │
│  ├─ 本地存储 (开发)                                            │
│  ├─ 云存储 (生产)                                              │
│  ├─ CDN分发                                                   │
│  └─ 备份策略                                                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    基础设施层 (Infrastructure Layer)             │
├─────────────────────────────────────────────────────────────────┤
│  容器化部署                                                       │
│  ├─ 容器运行时: Docker                                         │
│  ├─ 编排工具: Docker Compose                                   │
│  ├─ 镜像构建: Multi-stage Build                                │
│  └─ 安全扫描: 镜像漏洞扫描                                     │
│                                                                  │
│  操作系统                                                         │
│  ├─ 容器基础镜像: Alpine Linux                                 │
│  ├─ 系统依赖: 最小化安装                                       │
│  ├─ 时区配置: UTC + 本地时区                                   │
│  └─ 字体支持: 中文字体包                                       │
│                                                                  │
│  网络配置                                                         │
│  ├─ 端口映射: 8080 (API) + 80/443 (Web)                       │
│  ├─ 环境变量: 配置管理                                        │
│  ├─ 健康检查: HTTP端点检查                                     │
│  └─ 日志目录: 标准输出 + 文件日志                              │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 技术选型说明

**前端技术栈**：
- **HTML5 + CSS3**: 现代浏览器原生支持，无额外依赖
- **Tailwind CSS**: 原子化CSS框架，开发效率高，体积小
- **原生JavaScript**: 无框架依赖，兼容性好，学习成本低
- **WebSocket**: 浏览器原生支持，实时性好

**后端技术栈**：
- **Go + Gin**: 高性能、内存占用小、并发处理能力强
- **GORM**: Go生态成熟的ORM框架，开发效率高
- **SQLite/PostgreSQL**: SQLite开发便利，PostgreSQL生产可靠

**部署技术栈**：
- **Docker**: 容器化部署，环境一致性保障
- **Nginx**: 高性能反向代理，SSL终止，静态文件服务
- **Docker Compose**: 本地开发环境编排简单

---

## 部署架构图

### 5.1 开发环境部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        开发环境 (Development)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  │   Developer     │    │   Local Host    │    │   Local Service │
│  │   (开发者)       │    │   (本地主机)     │    │   (本地服务)     │
│  │                 │    │                 │    │                 │
│  │ ├─ VS Code      │    │ ├─ Docker       │    │ ├─ SQLite DB    │
│  │ ├─ Git          │    │ │  ├─ Backend    │    │ ├─ File Storage │
│  │ └─ Browser      │    │ │  └─ Frontend   │    │ └─ Cache        │
│  │                 │    │ │                │    │                 │
│  │ ┌─ Hot Reload   │    │ │ ┌─ Port 8080   │    │                 │
│  │ └─ Live Debug   │    │ │ └─ Port 3000   │    │                 │
│  └─────────────────┘    │ └─────────────────┘    └─────────────────┘
│                          │                         │
│                          ▼                         ▼
│                  ┌─────────────────┐       ┌─────────────────┐
│                  │   Docker        │       │   Data          │
│                  │   Compose       │       │   Directory     │
│                  │                 │       │                 │
│                  │ ├─ backend      │       │ ├─ ./data       │
│                  │ │  ├─ Gin API   │       │ ├─ ./logs       │
│                  │ │  ├─ WebSocket │       │ └─ ./uploads    │
│                  │ │  └─ Database  │       │                 │
│                  │ │               │       │                 │
│                  │ ├─ frontend     │       │                 │
│                  │ │  ├─ Nginx     │       │                 │
│                  │ │  └─ Static    │       │                 │
│                  │ │               │       │                 │
│                  │ └─ caddy        │       │                 │
│                  │    ├─ Auto SSL  │       │                 │
│                  │    └─ Reverse   │       │                 │
│                  │       Proxy     │       │                 │
│                  └─────────────────┘       └─────────────────┘
│                                │
│                                ▼
│                      ┌─────────────────┐
│                      │   Browser       │
│                      │   Access        │
│                      │                 │
│                      │ ├─ http://localhost:3000 │
│                      │ └─ http://localhost:8080 │
│                      └─────────────────┘
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 生产环境部署架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       生产环境 (Production)                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  │   Internet      │    │   CDN/Proxy     │    │   Load          │
│  │   (用户访问)     │    │   (分发网络)     │    │   Balancer      │
│  │                 │    │                 │    │   (负载均衡)     │  │
│  │ ┌─ 全球用户      │    │ ├─ Cloudflare   │    │ ├─ Nginx        │
│  │ └─ 移动/桌面     │    │ ├─ 静态资源缓存 │    │ ├─ SSL终止      │
│  │                 │    │ ├─ DDoS防护     │    │ ├─ 健康检查     │
│  │                 │    │ └─ 地理分布     │    │ └─ 流量分发    │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘
│                                │                        │
│                                ▼                        ▼
│  ┌─────────────────────────────────────────────────────────────┐
│  │                     应用服务器集群                           │
│  ├─────────────────────────────────────────────────────────────┤
│  │                                                               │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │  │   App Server 1  │  │   App Server 2  │  │   App Server N  │
│  │  │   (应用服务器1)   │  │   (应用服务器2)   │  │   (应用服务器N)   │  │
│  │  │                 │  │                 │  │                 │
│  │  │ ├─ Go Backend   │  │ ├─ Go Backend   │  │ ├─ Go Backend   │
│  │  │ │  ├─ Gin API   │  │ │  ├─ Gin API   │  │ │  ├─ Gin API   │
│  │  │ │  ├─ WebSocket │  │ │  ├─ WebSocket │  │ │  ├─ WebSocket │
│  │  │ │  └─ Business  │  │ │  └─ Business  │  │ │  └─ Business  │
│  │  │ │               │  │ │               │  │ │               │
│  │  │ ├─ Nginx        │  │ ├─ Nginx        │  │ ├─ Nginx        │
│  │  │ │  ├─ Static    │  │ │  ├─ Static    │  │ │  ├─ Static    │
│  │  │ │  ├─ Proxy     │  │ │  ├─ Proxy     │  │ │  ├─ Proxy     │
│  │  │ │  └─ Security  │  │ │  └─ Security  │  │ │  └─ Security  │
│  │  │ │               │  │ │               │  │ │               │
│  │  │ └─ Monitoring   │  │ └─ Monitoring   │  │ └─ Monitoring   │
│  │  │    ├─ Metrics   │  │    ├─ Metrics   │  │    ├─ Metrics   │
│  │  │    ├─ Logging   │  │    ├─ Logging   │  │    ├─ Logging   │
│  │  │    └─ Health    │  │    ├─ Health    │  │    ├─ Health    │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘
│  │                                                               │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │  │   Container     │  │   Container     │  │   Container     │
│  │  │   Orchestration │  │   Registry      │  │   CI/CD         │
│  │  │                 │  │                 │  │                 │
│  │  │ ├─ Docker Swarm │  │ ├─ Harbor       │  │ ├─ GitLab CI    │
│  │  │ ├─ Kubernetes   │  │ ├─ Docker Hub   │  │ ├─ Jenkins      │
│  │  │ └─ Auto Scaling │  │ └─ Image Scan   │  │ └─ Auto Deploy  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘
│  └─────────────────────────────────────────────────────────────┘
│                                │
│                                ▼
│  ┌─────────────────────────────────────────────────────────────┐
│  │                       数据层集群                             │
│  ├─────────────────────────────────────────────────────────────┤
│  │                                                               │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │  │   PostgreSQL    │  │     Redis       │  │   File Storage  │
│  │  │   Primary       │  │   Cache         │  │   (对象存储)     │
│  │  │                 │  │                 │  │                 │
│  │  │ ├─ Master DB    │  │ ├─ Session      │  │ ├─ 静态资源     │
│  │  │ ├─ Read Replica │  │ ├─ Rate Limit   │  │ ├─ 用户上传     │
│  │  │ ├─ Backup       │  │ ├─ Pub/Sub      │  │ ├─ 备份文件     │
│  │  │ └─ Monitoring   │  │ └─ Monitoring   │  │ └─ CDN分发     │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘
│  │                                                               │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  │  │   Monitoring    │  │   Logging       │  │   Security      │
│  │  │   & Alerting    │  │   System        │  │   & Backup      │
│  │  │                 │  │                 │  │                 │
│  │  │ ├─ Prometheus   │  │ ├─ ELK Stack    │  │ ├─ SSL Cert     │
│  │  │ ├─ Grafana      │  │ ├─ Filebeat     │  │ ├─ Firewall     │
│  │  │ ├─ AlertManager │  │ ├─ Logrotate    │  │ ├─ VPN Access   │
│  │  │ └─ Health Check │  │ └─ Centralized  │  │ └─ Auto Backup  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘
│  └─────────────────────────────────────────────────────────────┘
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 环境配置说明

**开发环境特点**：
- 单机部署，所有服务在一台机器上
- 使用Docker Compose编排
- SQLite数据库，无需额外配置
- Caddy自动SSL，简化HTTPS配置
- 热重载支持，开发效率高

**生产环境特点**：
- 容器化部署，支持水平扩展
- 负载均衡+多实例部署
- PostgreSQL主从复制，高可用
- Redis缓存集群，提升性能
- 完善的监控告警体系
- 自动备份和灾难恢复

---

## 关键组件详细设计说明

### 6.1 数据库设计 (Schema First)

#### 6.1.1 核心业务ER图

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   UserSession   │     │      Room        │     │   RoomMember    │
│  (用户会话)      │     │    (房间)        │     │   (房间成员)     │
├─────────────────┤     ├──────────────────┤     ├─────────────────┤
│ *id: UUID       │     │ *id: RoomCode    │     │ *id: UUID       │
│  nickname       │     │  name            │     │  room_id        │
│  avatar         │     │  description     │     │  session_id     │
│  room_id (FK)   │────▶│  creator_id      │     │  nickname       │
│  created_at     │     │  is_private      │     │  avatar         │
└─────────────────┘     │  password        │     │  role           │
                        │  max_users       │     │  joined_at      │
┌─────────────────┐     │  status          │     │  last_seen_at   │
│  PlaybackState  │     │  media_url       │◀────┤  created_at     │
│  (播放状态)      │     │  playback_state  │     └─────────────────┘
├─────────────────┤     │  current_time    │              ▲
│ *room_id        │     │  duration        │              │
│  is_playing     │     │  version         │              │
│  current_time   │     │  last_active_at  │              │
│  duration       │     │  created_at      │              │
│  playback_rate  │     │  updated_at      │              │
│  updated_at     │     └──────────────────┘              │
└─────────────────┘              │                         │
                                │                         │
┌─────────────────┐             │                         │
│  SyncMessage    │             │                         │
│  (同步消息)      │             │                         │
├─────────────────┤             │                         │
│ *id: UUID       │             │                         │
│  room_id        │─────────────┘                         │
│  session_id     │                                       │
│  message_type   │                                       │
│  payload        │                                       │
│  created_at     │                                       │
└─────────────────┘                                       │
                                                          │
┌─────────────────┐                                       │
│  RoomActivity   │                                       │
│  (房间活动日志)  │                                       │
├─────────────────┤                                       │
│ *id: UUID       │                                       │
│  room_id        │───────────────────────────────────────┘
│  activity_type  │
│  actor_session  │
│  details        │
│  created_at     │
└─────────────────┘
```

#### 6.1.2 SQLite DDL核心表结构

```sql
-- 用户会话表（临时会话）
CREATE TABLE user_sessions (
    id TEXT PRIMARY KEY,                    -- UUID主键
    nickname TEXT NOT NULL,                 -- 用户昵称
    avatar TEXT NOT NULL,                   -- 头像URL
    room_id TEXT,                          -- 当前所在房间ID
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_user_session_room 
        FOREIGN KEY (room_id) REFERENCES rooms(id) 
        ON DELETE SET NULL ON UPDATE CASCADE
);

-- 房间表（核心实体）
CREATE TABLE rooms (
    id TEXT PRIMARY KEY,                    -- 房间唯一ID
    name TEXT NOT NULL,                     -- 房间名称
    description TEXT,                       -- 房间描述
    creator_session_id TEXT NOT NULL,       -- 创建者会话ID
    is_private BOOLEAN DEFAULT 0,           -- 是否私有房间
    password TEXT,                          -- 房间密码（可选）
    max_users INTEGER DEFAULT 8,            -- 最大用户数
    status TEXT DEFAULT 'active',           -- 房间状态
    media_url TEXT NOT NULL,                -- 媒体资源URL
    playback_state TEXT DEFAULT 'paused',   -- 播放状态
    current_time REAL DEFAULT 0,            -- 当前播放时间
    duration REAL DEFAULT 0,                -- 媒体总时长
    version INTEGER DEFAULT 1,              -- 版本号（乐观锁）
    last_active_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_member_left_at DATETIME,           -- 最后成员离开时间
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_room_creator 
        FOREIGN KEY (creator_session_id) REFERENCES user_sessions(id),
    CONSTRAINT chk_room_status CHECK (status IN ('active', 'archived', 'deleted')),
    CONSTRAINT chk_playback_state CHECK (playback_state IN ('playing', 'paused', 'buffering'))
);

-- 房间成员表
CREATE TABLE room_members (
    id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    room_id TEXT NOT NULL,                  -- 房间ID
    session_id TEXT NOT NULL,               -- 会话ID
    nickname TEXT NOT NULL,                 -- 成员昵称
    avatar TEXT NOT NULL,                   -- 成员头像
    role TEXT DEFAULT 'member',             -- 角色：owner/admin/member
    is_active BOOLEAN DEFAULT 1,            -- 是否活跃
    joined_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    left_at DATETIME,                       -- 离开时间
    last_seen_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_member_room 
        FOREIGN KEY (room_id) REFERENCES rooms(id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_member_session 
        FOREIGN KEY (session_id) REFERENCES user_sessions(id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT uq_member_room_session UNIQUE (room_id, session_id),
    CONSTRAINT chk_member_role CHECK (role IN ('owner', 'admin', 'member'))
);

-- 播放状态表
CREATE TABLE playback_states (
    room_id TEXT PRIMARY KEY,               -- 房间ID（唯一）
    is_playing BOOLEAN DEFAULT 0,           -- 是否播放中
    current_time REAL DEFAULT 0,            -- 当前播放时间
    duration REAL DEFAULT 0,                -- 媒体总时长
    playback_rate REAL DEFAULT 1.0,         -- 播放速度
    volume REAL DEFAULT 1.0,                -- 音量
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_playback_room 
        FOREIGN KEY (room_id) REFERENCES rooms(id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT chk_playback_rate CHECK (playback_rate >= 0.25 AND playback_rate <= 2.0),
    CONSTRAINT chk_volume CHECK (volume >= 0.0 AND volume <= 1.0)
);

-- 同步消息表（WebSocket消息持久化）
CREATE TABLE sync_messages (
    id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    room_id TEXT NOT NULL,                  -- 房间ID
    session_id TEXT NOT NULL,               -- 发送者会话ID
    message_type TEXT NOT NULL,             -- 消息类型
    payload TEXT NOT NULL,                  -- JSON格式消息载荷
    client_timestamp DATETIME NOT NULL,     -- 客户端时间戳
    server_timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    processed BOOLEAN DEFAULT 0,            -- 是否已处理
    processing_error TEXT,                  -- 处理错误信息
    broadcast_to TEXT DEFAULT 'all',        -- 广播目标
    priority INTEGER DEFAULT 5,             -- 消息优先级
    expires_at DATETIME,                    -- 消息过期时间
    
    CONSTRAINT fk_message_room 
        FOREIGN KEY (room_id) REFERENCES rooms(id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_message_session 
        FOREIGN KEY (session_id) REFERENCES user_sessions(id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT chk_message_type CHECK (message_type IN ('play', 'pause', 'seek', 'sync', 'chat', 'system')),
    CONSTRAINT chk_message_priority CHECK (priority >= 1 AND priority <= 10)
);

-- 房间活动日志表
CREATE TABLE room_activities (
    id TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    room_id TEXT NOT NULL,                  -- 房间ID
    activity_type TEXT NOT NULL,            -- 活动类型
    actor_session TEXT NOT NULL,            -- 活动执行者会话ID
    target_session TEXT,                    -- 目标会话ID
    details TEXT,                           -- JSON格式详细信息
    metadata TEXT,                          -- JSON格式元数据
    ip_address TEXT,                        -- IP地址
    user_agent TEXT,                        -- 用户代理
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_activity_room 
        FOREIGN KEY (room_id) REFERENCES rooms(id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_activity_actor 
        FOREIGN KEY (actor_session) REFERENCES user_sessions(id) 
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_activity_target 
        FOREIGN KEY (target_session) REFERENCES user_sessions(id) 
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT chk_activity_type CHECK (activity_type IN (
        'room_created', 'room_updated', 'room_archived',
        'member_joined', 'member_left', 'member_kicked',
        'play_started', 'play_paused', 'play_seeked',
        'sync_error', 'connection_lost', 'connection_restored'
    ))
);
```

#### 6.1.3 索引优化策略

```sql
-- 核心查询索引
CREATE INDEX idx_user_sessions_room ON user_sessions(room_id);
CREATE INDEX idx_user_sessions_created ON user_sessions(created_at);

CREATE INDEX idx_rooms_creator ON rooms(creator_session_id);
CREATE INDEX idx_rooms_status ON rooms(status);
CREATE INDEX idx_rooms_last_active ON rooms(last_active_at);

CREATE INDEX idx_room_members_room ON room_members(room_id);
CREATE INDEX idx_room_members_session ON room_members(session_id);
CREATE INDEX idx_room_members_active ON room_members(is_active, left_at);

CREATE INDEX idx_sync_messages_room ON sync_messages(room_id);
CREATE INDEX idx_sync_messages_timestamp ON sync_messages(server_timestamp);
CREATE INDEX idx_sync_messages_processed ON sync_messages(processed, server_timestamp);

-- 复合索引（多字段查询优化）
CREATE INDEX idx_room_members_room_active ON room_members(room_id, is_active, left_at);
CREATE INDEX idx_sync_messages_room_type_time ON sync_messages(room_id, message_type, server_timestamp);
CREATE INDEX idx_room_activities_room_type_time ON room_activities(room_id, activity_type, created_at);
```

### 6.2 API契约设计 (OpenAPI 3.0)

#### 6.2.1 RESTful接口规范

**基础URL**: `https://api.xiaowo.com/v1` (生产) / `http://localhost:8080/v1` (开发)

**统一响应格式**:
```json
{
  "code": 200,
  "message": "success", 
  "data": {},
  "request_id": "uuid-string",
  "timestamp": "2025-12-30T10:30:00Z"
}
```

**核心接口列表**:

**A. 房间管理接口**
```
POST   /rooms              # 创建房间
GET    /rooms/{room_id}    # 获取房间详情
PUT    /rooms/{room_id}    # 更新房间信息
DELETE /rooms/{room_id}    # 删除/归档房间
GET    /rooms              # 房间列表（支持分页和筛选）
```

**B. 用户会话接口**
```
POST   /sessions           # 创建用户会话
GET    /sessions/{session_id}  # 获取会话信息
PUT    /sessions/{session_id}  # 更新会话信息
DELETE /sessions/{session_id}  # 销毁会话
```

**C. 成员管理接口**
```
POST   /rooms/{room_id}/members     # 加入房间
DELETE /rooms/{room_id}/members/{session_id}  # 离开房间
GET    /rooms/{room_id}/members     # 获取房间成员列表
PUT    /rooms/{room_id}/members/{session_id}  # 更新成员信息
```

**D. 播放控制接口**
```
GET    /rooms/{room_id}/playback    # 获取播放状态
PUT    /rooms/{room_id}/playback    # 更新播放状态
POST   /rooms/{room_id}/play        # 播放
POST   /rooms/{room_id}/pause       # 暂停
POST   /rooms/{room_id}/seek        # 跳转
POST   /rooms/{room_id}/sync        # 强制同步
```

#### 6.2.2 错误码体系

```json
{
  "errors": {
    "system": {
      "1001": "内部错误",
      "1002": "数据库错误",
      "1003": "网络错误"
    },
    "auth": {
      "2001": "无效Token",
      "2002": "Token过期",
      "2003": "权限不足"
    },
    "business": {
      "3001": "房间不存在",
      "3002": "房间已满",
      "3003": "用户已在房间中",
      "3004": "媒体资源无效",
      "3005": "播放状态冲突"
    },
    "validation": {
      "4001": "参数缺失",
      "4002": "参数无效",
      "4003": "参数过长",
      "4004": "格式错误"
    }
  }
}
```

### 6.3 WebSocket实时同步设计

#### 6.3.1 WebSocket消息协议

**消息格式**:
```json
{
  "id": "message-uuid",
  "type": "play|pause|seek|sync|chat|system",
  "room_id": "room-code",
  "session_id": "session-uuid",
  "payload": {
    // 消息载荷，根据type不同而不同
  },
  "timestamp": "2025-12-30T10:30:00Z",
  "client_timestamp": "2025-12-30T10:29:59.500Z"
}
```

**消息类型定义**:
```go
type MessageType string

const (
    MsgTypePlay    MessageType = "play"
    MsgTypePause   MessageType = "pause"
    MsgTypeSeek    MessageType = "seek"
    MsgTypeSync    MessageType = "sync"
    MsgTypeChat    MessageType = "chat"
    MsgTypeSystem  MessageType = "system"
)

type PlayPayload struct {
    CurrentTime float64 `json:"current_time"` // 播放时间（秒）
    Rate        float64 `json:"rate"`         // 播放速度
    Volume      float64 `json:"volume"`       // 音量
}

type SeekPayload struct {
    CurrentTime float64 `json:"current_time"` // 跳转时间（秒）
    Reason      string  `json:"reason"`       // 跳转原因
}

type SyncPayload struct {
    TargetTime  float64 `json:"target_time"`  // 目标同步时间
    DelayMs     int     `json:"delay_ms"`     // 网络延迟（毫秒）
    SkewMs      int     `json:"skew_ms"`      // 时间偏差（毫秒）
}
```

#### 6.3.2 WebSocket Hub设计

```go
type Hub struct {
    rooms      map[string]*Room
    clients    map[string]*Client
    register   chan *Client
    unregister chan *Client
    broadcast  chan *Message
    mutex      sync.RWMutex
}

type Room struct {
    id        string
    clients   map[string]*Client
    mutex     sync.RWMutex
    createdAt time.Time
}

type Client struct {
    id         string
    roomId     string
    sessionId  string
    socket     *websocket.Conn
    send       chan []byte
    hub        *Hub
}

func (h *Hub) RegisterClient(client *Client) {
    h.mutex.Lock()
    defer h.mutex.Unlock()
    
    h.clients[client.id] = client
    
    // 添加到房间
    if room, exists := h.rooms[client.roomId]; exists {
        room.mutex.Lock()
        room.clients[client.id] = client
        room.mutex.Unlock()
    }
}

func (h *Hub) BroadcastToRoom(roomId string, message *Message) {
    h.mutex.RLock()
    room, exists := h.rooms[roomId]
    h.mutex.RUnlock()
    
    if !exists {
        return
    }
    
    room.mutex.RLock()
    defer room.mutex.RUnlock()
    
    data, _ := json.Marshal(message)
    for _, client := range room.clients {
        select {
        case client.send <- data:
        default:
            close(client.send)
            delete(room.clients, client.id)
        }
    }
}
```

### 6.4 异常处理与降级策略

#### 6.4.1 分层异常处理

```go
type ErrorHandler struct {
    dbHandler    *DatabaseErrorHandler
    wsHandler    *WebSocketErrorHandler
    businessHandler *BusinessErrorHandler
    retryManager *RetryManager
}

type DatabaseErrorHandler struct{}

func (h *DatabaseErrorHandler) Handle(err error, ctx *RequestContext) *ErrorResponse {
    switch err {
    case sql.ErrNoRows:
        return &ErrorResponse{
            Code:    3001,
            Message: "房间不存在",
            Details: "请求的房间不存在或已删除",
        }
    case sql.ErrConnDone:
        return &ErrorResponse{
            Code:    1002,
            Message: "数据库连接失败",
            Details: "数据库连接中断，请稍后重试",
        }
    default:
        log.WithError(err).WithField("request_id", ctx.RequestID).Error("database_error")
        return &ErrorResponse{
            Code:    1002,
            Message: "数据库操作失败",
            Details: "系统内部错误，请联系管理员",
        }
    }
}
```

#### 6.4.2 熔断器模式

```go
type CircuitBreaker struct {
    name            string
    state           CircuitState
    failureCount    int
    successCount    int
    lastFailureTime time.Time
    config          CircuitBreakerConfig
    mutex           sync.Mutex
}

type CircuitState int

const (
    Closed CircuitState = iota
    Open
    HalfOpen
)

type CircuitBreakerConfig struct {
    FailureThreshold int           // 失败阈值
    RecoveryTimeout  time.Duration // 恢复超时
    SuccessThreshold int           // 半开状态成功阈值
}

func (cb *CircuitBreaker) Execute(fn func() error) error {
    cb.mutex.Lock()
    defer cb.mutex.Unlock()
    
    switch cb.state {
    case Open:
        if time.Since(cb.lastFailureTime) > cb.config.RecoveryTimeout {
            cb.state = HalfOpen
            cb.successCount = 0
        } else {
            return ErrCircuitOpen
        }
    case HalfOpen:
        // 允许一个请求测试
    case Closed:
        // 正常执行
    }
    
    err := fn()
    
    if err != nil {
        cb.failureCount++
        cb.lastFailureTime = time.Now()
        
        if cb.failureCount >= cb.config.FailureThreshold {
            cb.state = Open
        }
        return err
    }
    
    cb.successCount++
    if cb.state == HalfOpen && cb.successCount >= cb.config.SuccessThreshold {
        cb.state = Closed
        cb.failureCount = 0
    }
    
    return nil
}
```

#### 6.4.3 重试策略

```go
type RetryConfig struct {
    MaxAttempts    int           // 最大重试次数
    InitialDelay   time.Duration // 初始延迟
    MaxDelay       time.Duration // 最大延迟
    Strategy       RetryStrategy // 重试策略
    Jitter         bool          // 是否添加随机抖动
}

type RetryManager struct {
    configs map[string]*RetryConfig
}

func (m *RetryManager) ExecuteWithRetry(operation string, fn func() error) error {
    config, exists := m.configs[operation]
    if !exists {
        config = m.configs["default"]
    }
    
    var err error
    delay := config.InitialDelay
    
    for attempt := 0; attempt <= config.MaxAttempts; attempt++ {
        err = fn()
        if err == nil {
            return nil
        }
        
        if attempt == config.MaxAttempts {
            break
        }
        
        time.Sleep(delay)
        
        // 计算下次延迟
        switch config.Strategy {
        case ExponentialBackoff:
            delay = delay * 2
            if delay > config.MaxDelay {
                delay = config.MaxDelay
            }
        case LinearBackoff:
            delay = delay + config.InitialDelay
            if delay > config.MaxDelay {
                delay = config.MaxDelay
            }
        }
        
        // 添加随机抖动
        if config.Jitter {
            jitter := time.Duration(rand.Float64() * float64(delay))
            delay = delay + jitter/2
        }
    }
    
    return err
}
```

### 6.5 性能优化策略

#### 6.5.1 数据库优化

**连接池配置**:
```go
func InitDatabase() (*gorm.DB, error) {
    db, err := gorm.Open(sqlite.Open("xiaowo.db"), &gorm.Config{
        Logger: logger.Default.LogMode(logger.Info),
    })
    
    if err != nil {
        return nil, err
    }
    
    // 获取底层sql.DB对象配置连接池
    sqlDB, err := db.DB()
    if err != nil {
        return nil, err
    }
    
    // 连接池配置
    sqlDB.SetMaxIdleConns(10)           // 最大空闲连接数
    sqlDB.SetMaxOpenConns(100)          // 最大连接数
    sqlDB.SetConnMaxLifetime(time.Hour) // 连接最大生命周期
    
    // 启用WAL模式提升并发性能
    sqlDB.Exec("PRAGMA journal_mode=WAL")
    sqlDB.Exec("PRAGMA synchronous=NORMAL")
    sqlDB.Exec("PRAGMA cache_size=1000")
    sqlDB.Exec("PRAGMA temp_store=memory")
    
    return db, nil
}
```

**查询优化**:
```go
// 预编译查询减少解析时间
var (
    getRoomStmt      *sql.Stmt
    getMembersStmt   *sql.Stmt
    insertMessageStmt *sql.Stmt
)

func PrepareStatements(db *sql.DB) error {
    var err error
    
    getRoomStmt, err = db.Prepare(`
        SELECT id, name, media_url, playback_state, current_time, duration, version
        FROM rooms WHERE id = ? AND status = 'active'
    `)
    
    getMembersStmt, err = db.Prepare(`
        SELECT session_id, nickname, avatar, role, last_seen_at
        FROM room_members 
        WHERE room_id = ? AND is_active = 1 
        ORDER BY joined_at ASC
    `)
    
    insertMessageStmt, err = db.Prepare(`
        INSERT INTO sync_messages (room_id, session_id, message_type, payload, client_timestamp)
        VALUES (?, ?, ?, ?, ?)
    `)
    
    return err
}
```

#### 6.5.2 WebSocket优化

**连接池管理**:
```go
type ConnectionPool struct {
    pools     map[string]*websocket.Pool
    maxConns  int
    mutex     sync.RWMutex
}

func NewConnectionPool(maxConns int) *ConnectionPool {
    return &ConnectionPool{
        pools:    make(map[string]*websocket.Pool),
        maxConns: maxConns,
    }
}

func (p *ConnectionPool) GetPool(roomId string) *websocket.Pool {
    p.mutex.RLock()
    pool, exists := p.pools[roomId]
    p.mutex.RUnlock()
    
    if !exists {
        p.mutex.Lock()
        defer p.mutex.Unlock()
        
        // 双重检查
        if pool, exists = p.pools[roomId]; !exists {
            pool = websocket.NewPool(p.maxConns, websocket.JSON)
            p.pools[roomId] = pool
        }
    }
    
    return pool
}
```

**消息批处理**:
```go
type MessageBatcher struct {
    messages  []*Message
    timer     *time.Timer
    batchSize int
    maxDelay  time.Duration
    callback  func([]*Message)
    mutex     sync.Mutex
}

func NewMessageBatcher(batchSize int, maxDelay time.Duration, callback func([]*Message)) *MessageBatcher {
    return &MessageBatcher{
        batchSize: batchSize,
        maxDelay:  maxDelay,
        callback:  callback,
    }
}

func (b *MessageBatcher) AddMessage(msg *Message) {
    b.mutex.Lock()
    defer b.mutex.Unlock()
    
    b.messages = append(b.messages, msg)
    
    if len(b.messages) >= b.batchSize {
        b.flush()
        return
    }
    
    if b.timer == nil {
        b.timer = time.AfterFunc(b.maxDelay, b.flush)
    }
}

func (b *MessageBatcher) flush() {
    b.mutex.Lock()
    defer b.mutex.Unlock()
    
    if len(b.messages) == 0 {
        return
    }
    
    messages := make([]*Message, len(b.messages))
    copy(messages, b.messages)
    b.messages = b.messages[:0]
    
    if b.timer != nil {
        b.timer.Stop()
        b.timer = nil
    }
    
    go b.callback(messages)
}
```

---

## 架构设计总结

### 7.1 设计亮点

**1. Schema First设计理念**
- 数据库设计先行于业务逻辑
- 完整的外键约束确保数据一致性
- 索引策略优化查询性能
- 触发器实现自动化业务逻辑

**2. MVP架构选择**
- 单体架构避免过度设计
- SQLite开发便利，PostgreSQL生产可靠
- 最小可行功能集合，快速迭代

**3. 实时同步架构**
- WebSocket原生支持，无需额外依赖
- Hub模式管理房间和客户端连接
- 消息持久化确保同步可靠性
- 批处理机制优化网络性能

**4. 异常处理与降级**
- 分层异常处理体系
- 熔断器模式防止雪崩效应
- 多级重试策略提升成功率
- 完善的降级方案保障可用性

**5. 开发体验优化**
- 清晰的目录结构组织
- 统一的API契约设计
- 完善的中间件体系
- 自动化部署配置

### 7.2 性能指标预期

**并发能力**:
- 单实例支持1000+并发WebSocket连接
- API接口支持500+ QPS
- 数据库支持100+并发读写

**延迟指标**:
- WebSocket消息延迟 < 50ms
- API响应时间 < 200ms
- 数据库查询时间 < 10ms

**可用性指标**:
- 系统可用性 > 99.5%
- 故障恢复时间 < 30秒
- 数据一致性保障

### 7.3 可扩展性设计

**水平扩展能力**:
- 无状态应用服务支持负载均衡
- 数据库读写分离架构
- 缓存集群支持高并发访问

**功能扩展性**:
- 模块化业务逻辑设计
- 消息类型可扩展
- API版本向后兼容
- 插件化中间件机制

### 7.4 运维友好性

**监控体系**:
- 业务指标监控
- 性能指标跟踪
- 异常告警机制
- 日志集中管理

**部署自动化**:
- Docker容器化部署
- 一键部署脚本
- 环境配置管理
- 灰度发布支持

### 7.5 安全设计

**数据安全**:
- 参数输入验证
- SQL注入防护
- XSS攻击防护
- CSRF保护

**网络安全**:
- HTTPS加密传输
- 请求频率限制
- IP白名单机制
- 安全头配置

**业务安全**:
- 房间权限控制
- 用户身份验证
- 操作审计日志
- 敏感数据脱敏

---

**文档版本**: v1.0  
**最后更新**: 2025-12-30  
**审核状态**: 已完成  
**下一步**: 开始实施开发