# 小窝项目数据流程图

## 数据流程概述

本文档展示小窝系统中数据的完整生命周期，包括数据输入、处理、存储、传输和输出的全过程。

## 1. 用户会话数据流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 浏览器   │    │ Nginx网关   │    │ HTTP API    │    │ 会话管理    │    │ 数据库  │
└────┬────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘
     │                │                │                │                │
     │ 1. 访问网站     │                │                │                │
     │---------------->│                │                │                │
     │                │ HTTP请求转发   │                │                │
     │                │---------------->│                │                │
     │                │                │ 生成会话ID     │                │
     │                │                │---------------->│                │
     │                │                │                │ CreateSession │
     │                │                │                │-------------->│
     │                │                │                │                │INSERT INTO
     │                │                │                │                │user_sessions
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │ 返回会话ID     │                │
     │                │                │<----------------│                │
     │                │ 响应 + Cookie  │                │                │
     │                │<----------------│                │                │
     │ 2. 接收会话     │                │                │                │
     │<----------------│                │                │                │
     │                │                │                │                │
     │ SessionCreated │                │                │                │
     └────────────────┘                │                │                │
                                     │                │                │
┌─────────────────────────────────────┴────────────────┴────────────────┴────────────────┐
│                                                                                         │
│  数据流: 浏览器 -> Nginx -> HTTP API -> 会话管理 -> 数据库                                 │
│  存储: user_sessions表 (session_id, created_at, last_accessed, expires_at)                │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 2. 房间管理数据流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端   │    │ HTTP API    │    │ 房间管理    │    │ 数据访问层  │    │ 数据库  │
└────┬────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘
     │                │                │                │                │
     │ POST /rooms    │                │                │                │
     │ (name,desc)    │                │                │                │
     │---------------->│                │                │                │
     │                │ 验证会话       │                │                │
     │                │---------------->│                │                │
     │                │                │ 验证参数       │                │
     │                │                │---------------->│                │
     │                │                │ 创建房间       │                │
     │                │                │---------------->│                │
     │                │                │                │ InsertRoom     │
     │                │                │                │-------------->│
     │                │                │                │                │INSERT INTO rooms
     │                │                │                │                │(id,name,desc,creator_id)
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │ 记录审计日志   │                │
     │                │                │------------------------------------------------>│
     │                │                │                │                │INSERT INTO audit_logs
     │                │                │                │                │(action,user_id,room_id)
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │ 房间响应       │                │                │
     │                │<------------------------------------------------│
     │ 房间创建成功   │                │                │                │
     │<----------------│                │                │                │
     │                │                │                │                │
┌────┴────┐    ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐    └────┬────┘
│ 客户端   │    │ HTTP API    │    │ 房间管理    │    │ 数据访问层  │    │ 数据库  │
└─────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘

数据存储路径:
- 主表: rooms (房间基本信息)
- 关联表: room_members (房间成员关系)
- 审计表: audit_logs (操作记录)
```

## 3. 实时同步数据流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端A  │    │ WebSocket   │    │ 同步服务    │    │ 状态管理    │    │ 数据库  │
└────┬────┘    │   Hub       │    │            │    │            │    │         │
     │         └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘
     │                │                │                │                │
     │ SyncReq        │                │                │                │
     │(videoPos=100)  │                │                │                │
     │---------------->│                │                │                │
     │                │ 消息路由       │                │                │
     │                │---------------->│                │                │
     │                │                │ 验证同步       │                │
     │                │                │---------------->│                │
     │                │                │                │ LoadCurrent   │
     │                │                │                │--------------->│
     │                │                │                │                │SELECT current_state
     │                │                │                │                │FROM rooms
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │ 广播同步       │                │
     │                │                │---------------->│                │
     │                │ BroadcastSync  │                │                │
     │                │<------------------------------------------------│
     │                │                │                │                │
     │                │ 消息转发到其他│                │                │
     │                │<------------------------------------------------│
     │                │                │                │                │
     │ SyncRes        │                │                │                │
     │(videoPos=100)  │                │                │                │
     │<----------------│                │                │                │
     │                │                │ 更新状态       │                │
     │                │                │------------------------------------------------>│
     │                │                │                │ UpdatePlayback │
     │                │                │                │--------------->│
     │                │                │                │                │UPDATE rooms SET
     │                │                │                │                │playback_state
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │                │                │
     │                │                │ 记录同步日志   │                │
     │                │                │------------------------------------------------>│
     │                │                │                │                │INSERT INTO sync_logs
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │                │                │
┌────┴────┐    ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐    └────┬────┘
│ 客户端A  │    │ WebSocket   │    │ 同步服务    │    │ 状态管理    │    │ 数据库  │
└─────────┘    │   Hub       │    │            │    │            │    │         │
               └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘

数据流特点:
- 实时性: 消息延迟 < 100ms
- 一致性: 基于版本号的乐观锁
- 持久化: 关键状态持久化到数据库
- 广播: 1对多消息分发
```

## 4. 聊天消息数据流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 客户端A  │    │ WebSocket   │    │ 消息服务    │    │ 消息队列    │    │ 数据库  │
└────┬────┘    │   Hub       │    │            │    │            │    │         │
     │         └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘
     │                │                │                │                │
     │ ChatMsg        │                │                │                │
     │(text="Hello")  │                │                │                │
     │---------------->│                │                │                │
     │                │ 消息验证       │                │                │
     │                │---------------->│                │                │
     │                │                │ 格式化消息     │                │
     │                │                │---------------->│                │
     │                │                │                │ 消息入队       │
     │                │                │                │--------------->│
     │                │                │                │                │INSERT INTO messages
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │ 消息持久化     │                │
     │                │                │<--------------------------------│
     │                │                │                │                │
     │                │ 广播消息       │                │                │
     │                │------------------------------------------------>│
     │                │                │                │                │
     │                │ BroadcastChat  │                │                │
     │                │<------------------------------------------------│
     │                │                │                │                │
     │ ChatReceived   │                │                │                │
     │<------------------------------------------------│                │
     │                │                │                │                │
     │                │                │ 消息确认       │                │
     │                │                │<--------------------------------│
     │                │                │                │                │
     │                │                │                │ 消息出队确认   │
     │                │                │                │--------------->│
     │                │                │                │                │UPDATE messages SET
     │                │                │                │                │status='delivered'
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │                │                │
┌────┴────┐    ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐    └────┬────┘
│ 客户端A  │    │ WebSocket   │    │ 消息服务    │    │ 消息队列    │    │ 数据库  │
└─────────┘    │   Hub       │    │            │    │            │    │         │
               └─────────────┘    └─────────────┘    └─────────────┘    └─────────┘
```

## 5. 系统监控数据流程

```
┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────┐
│ 应用服务 │    │ 监控收集    │    │ 数据聚合    │    │ 告警系统    │    │ 存储系统 │
└────┬────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └────┬────┘
     │                │                │                │                │
     │ 1. 性能指标    │                │                │                │
     │---------------->│                │                │                │
     │                │ 指标收集       │                │                │
     │                │---------------->│                │                │
     │                │                │ 数据聚合       │                │
     │                │                │---------------->│                │
     │                │                │                │ 触发告警检查   │
     │                │                │                │--------------->│
     │                │                │                │                │检查阈值
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │                │                │
     │                │                │                │ 告警发送       │
     │                │                │                │--------------->│
     │                │                │                │                │发送邮件/短信
     │                │                │                │                │---------------->│
     │                │                │ 指标存储       │                │
     │                │                │------------------------------------------------>│
     │                │                │                │                │INSERT INTO metrics
     │                │                │                │                │---------------->│
     │                │                │                │                │◄─────┐
     │                │                │                │                │
┌─────────────────────────────────────┴────────────────┴────────────────┴────────────────┐
│                                                                                         │
│  监控数据流: 应用服务 -> 监控收集 -> 数据聚合 -> 告警检查 -> 存储/告警                      │
│  关键指标: QPS, 响应时间, 错误率, 连接数, 内存使用率                                     │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## 6. 数据生命周期管理

### 数据创建阶段
- **会话数据**: 首次访问时生成，存储在 `user_sessions` 表
- **房间数据**: 用户创建房间时生成，存储在 `rooms` 表
- **成员关系**: 加入房间时生成，存储在 `room_members` 表

### 数据更新阶段
- **播放状态**: 实时同步时更新，存储在 `rooms.playback_state`
- **用户活动**: 每次操作时更新 `user_sessions.last_accessed`
- **房间活跃**: 有用户操作时更新 `rooms.last_active_at`

### 数据查询阶段
- **房间列表**: 按 `status='active'` 和时间排序查询
- **成员信息**: 按 `room_id` 关联查询 `room_members` 和 `user_sessions`
- **历史记录**: 按时间范围查询 `audit_logs` 和 `sync_logs`

### 数据清理阶段
- **过期会话**: 定时清理 `user_sessions` 中过期的记录
- **非活跃房间**: 定时清理 `rooms` 中超过1小时未活跃的房间
- **历史日志**: 按策略保留或清理 `audit_logs` 和 `sync_logs`

## 数据安全策略

### 1. 数据加密
- **敏感数据**: 房间密码使用 bcrypt 哈希存储
- **传输加密**: 所有HTTP通信使用HTTPS
- **数据库**: SQLite文件加密存储

### 2. 数据校验
- **输入校验**: 所有用户输入进行严格校验
- **SQL注入防护**: 使用参数化查询
- **XSS防护**: 前端输入内容进行转义

### 3. 数据备份
- **定期备份**: 每日自动备份数据库文件
- **增量备份**: 基于时间戳的增量备份
- **异地备份**: 备份文件存储到不同位置

### 4. 数据审计
- **操作记录**: 所有关键操作记录到审计日志
- **访问日志**: 记录所有数据访问请求
- **异常监控**: 异常操作实时告警

---

**版本**: v1.0  
**最后更新**: 2025-12-30  
**作者**: 系统架构师  
**状态**: 已完成