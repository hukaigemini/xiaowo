# 小窝项目系统整体架构图

## 架构概述

小窝项目采用**单体架构**设计，基于前后端分离模式，专注于**视频同步观看**的核心业务场景。系统设计遵循**高内聚、低耦合**原则，确保MVP阶段快速交付和易于维护。

## 系统整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           小窝系统整体架构                                            │
├─────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                    │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │   客户端层    │    │   客户端层    │    │   客户端层    │    │   管理后台    │                  │
│  │              │    │              │    │              │    │              │                  │
│  │  Vue 3 + TS  │    │   移动端App   │    │   PWA应用    │    │  Admin UI    │                  │
│  │  TailwindCSS │    │    (预留)     │    │   (预留)     │    │    (预留)     │                  │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘    └──────┬───────┘                  │
│         │                   │                   │                   │                          │
│         ▼                   ▼                   ▼                   ▼                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                   网络接入层 (Nginx)                                          │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │  │  HTTP反向代理   │  │   WebSocket    │  │   静态资源     │  │    SSL/TLS     │         │ │
│  │  │                │  │   代理转发     │  │     服务       │  │   证书管理     │         │ │
│  │  │  - 路由分发     │  │                │  │                │  │                │         │ │
│  │  │  - 负载均衡     │  │  - 连接升级     │  │  - 资源缓存     │  │  - HTTPS终止   │         │ │
│  │  │  - 请求限流     │  │  - 消息转发     │  │  - Gzip压缩     │  │  - 安全头设置  │         │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                                          │
│                                         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                   应用服务层 (Go)                                              │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                        小窝后端服务 (单体应用)                                           │ │ │
│  │  │                                                                                         │ │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │ │ │
│  │  │  │ HTTP API    │  │ WebSocket  │  │ 业务逻辑层  │  │  数据访问层  │                   │ │ │
│  │  │  │             │  │   Hub      │  │             │  │             │                   │ │ │
│  │  │  │ - RESTful   │  │            │  │ - 房间管理  │  │ - GORM ORM  │                   │ │ │
│  │  │  │ - JSON响应  │  │ - 连接管理  │  │ - 同步逻辑  │  │ - 事务管理  │                   │ │ │
│  │  │  │ - 参数校验  │  │ - 消息广播  │  │ - 状态同步  │  │ - 查询优化  │                   │ │ │
│  │  │  │ - 错误处理  │  │ - 心跳检测  │  │ - 权限控制  │  │ - 连接池    │                   │ │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                   │ │ │
│  │  │                                                                                         │ │ │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                   │ │ │
│  │  │  │   核心服务   │  │   辅助服务   │  │   中间件     │  │   配置管理   │                   │ │ │
│  │  │  │             │  │             │  │             │  │             │                   │ │ │
│  │  │  │ - 房间服务   │  │ - 日志服务   │  │ - 鉴权中间件 │  │ - 环境配置  │                   │ │ │
│  │  │  │ - 用户服务   │  │ - 监控服务   │  │ - 限流中间件 │  │ - 动态配置  │                   │ │ │
│  │  │  │ - 同步服务   │  │ - 缓存服务   │  │ - CORS中间件 │  │ - 功能开关  │                   │ │ │
│  │  │  │ - 消息服务   │  │ - 任务调度   │  │ - 日志中间件 │  │ - 错误码配置│                   │ │ │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                   │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────────────────────┘ │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                                          │
│                                         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                                     数据存储层                                                 │ │
│  │                                                                                                │ │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                              │ │
│  │  │   主数据库       │  │   缓存层        │  │   文件存储       │                              │ │
│  │  │                │  │                │  │                │                              │ │
│  │  │  SQLite 3.x    │  │   (预留Redis)   │  │   (预留OSS)     │                              │ │
│  │  │                │  │                │  │                │                              │ │
│  │  │  - rooms        │  │  - 会话缓存     │  │  - 房间缩略图   │                              │ │
│  │  │  - room_members │  │  - 状态缓存     │  │  - 用户头像     │                              │ │
│  │  │  - user_sessions│  │  - 配置缓存     │  │  - 日志文件     │                              │ │
│  │  │  - audit_logs   │  │  - 临时数据     │  │  - 备份文件     │                              │ │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘                              │ │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## 架构特点

### 1. 技术栈选型
- **前端**: Vue 3 + TypeScript + TailwindCSS
- **网关**: Nginx (反向代理 + 负载均衡)
- **后端**: Go + Gin + GORM
- **数据库**: SQLite (MVP阶段)
- **通信**: HTTP RESTful API + WebSocket

### 2. 设计原则
- **单体优先**: MVP阶段选择单体架构，避免微服务复杂性
- **前后端分离**: 清晰的职责分离，便于独立开发部署
- **实时通信**: WebSocket确保同步观看的实时性
- **数据一致性**: 基于版本号的乐观锁机制
- **安全优先**: 多层安全防护机制

### 3. 扩展性设计
- **水平扩展**: 通过Nginx负载均衡支持多实例部署
- **垂直扩展**: Go语言高性能特性支持高并发
- **数据扩展**: 预留Redis缓存和MySQL迁移路径
- **功能扩展**: 模块化设计支持功能增量开发

### 4. 监控运维
- **日志记录**: 结构化日志记录关键操作
- **性能监控**: 内置性能指标收集
- **错误追踪**: 完整的错误处理和上报机制
- **健康检查**: 服务状态监控和自动恢复

## 核心接口定义

### HTTP API接口
```
基础路径: /api/v1
├── /rooms          房间管理接口
│   ├── GET    /rooms              获取房间列表
│   ├── POST   /rooms              创建房间
│   ├── GET    /rooms/{id}         获取房间详情
│   ├── PUT    /rooms/{id}         更新房间信息
│   └── DELETE /rooms/{id}         删除房间
├── /rooms/{id}/members  成员管理接口
│   ├── GET    /rooms/{id}/members     获取成员列表
│   ├── POST   /rooms/{id}/members     加入房间
│   ├── DELETE /rooms/{id}/members/{sessionId}  离开房间
└── /health         健康检查接口
    └── GET    /health             服务健康状态
```

### WebSocket接口
```
连接路径: /ws/v1/room/{roomId}
├── 客户端 -> 服务器
│   ├── {"type": "join", "sessionId": "xxx"}     加入房间
│   ├── {"type": "leave"}                        离开房间
│   ├── {"type": "sync", "timestamp": 12345}     同步播放进度
│   ├── {"type": "chat", "message": "文本"}      发送聊天消息
│   └── {"type": "ping"}                         心跳检测
└── 服务器 -> 客户端
    ├── {"type": "joined", "members": [...]}     加入成功
    ├── {"type": "member_left", "sessionId": "xxx"} 成员离开
    ├── {"type": "sync", "timestamp": 12345}     同步消息
    ├── {"type": "chat", "message": "文本", "from": "xxx"} 聊天消息
    ├── {"type": "pong"}                         心跳响应
    └── {"type": "error", "message": "错误信息"}  错误消息
```

## 安全架构

### 1. 网络安全
- HTTPS强制加密传输
- CORS跨域策略控制
- 请求频率限制
- IP白名单机制

### 2. 应用安全
- 会话令牌验证
- 房间访问权限控制
- 输入参数严格校验
- XSS攻击防护

### 3. 数据安全
- 敏感数据加密存储
- 房间密码哈希处理
- 操作日志审计
- 数据备份机制

---

**版本**: v1.0  
**最后更新**: 2025-12-30  
**作者**: 系统架构师  
**状态**: 已完成